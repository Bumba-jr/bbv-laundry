<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laundry Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="apple-touch-icon" sizes="180x180" href="../assets/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="../assets/img/favicon/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-functions-compat.js"></script>

   <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Chart Bars (Bottom Section) */
        .bar-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 180px;
            padding-top: 20px;
            position: relative;
        }
        .chart-grid-line {
            position: absolute;
            left: 0;
            right: 0;
            border-top: 1px dashed #e5e5e5;
            z-index: 0;
        }
        .bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: calc(100% / 7);
            min-width: 20px;
            position: relative;
            z-index: 1;
            height: 100%;
            justify-content: flex-end;
        }
        .bar {
            width: 70%;
            background-color: #e5e5e5;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease-out, background-color 0.3s;
            min-height: 2px;
        }
        .bar.active { background-color: #007aff; }
        .bar:hover { opacity: 0.8; }
        .bar-label {
            margin-top: 8px;
            font-size: 10px;
            color: #86868b;
            text-align: center;
            height: 15px;
        }
        .bar-value {
            font-size: 9px;
            color: #666;
            margin-bottom: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .bar-wrapper:hover .bar-value { opacity: 1; }
        .bar-hover-tooltip {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1d1d1f;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .bar-hover-tooltip::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #1d1d1f;
        }
        .bar-wrapper:hover .bar-hover-tooltip {
            opacity: 1;
        }
        .bar-bottom-tooltip {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1d1d1f;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            text-align: center;
            line-height: 1.4;
            white-space: nowrap;
        }
        .bar-bottom-tooltip::after {
            content: '';
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid #1d1d1f;
        }
        .bar-wrapper:hover .bar-bottom-tooltip {
            opacity: .71;
        }

        [data-animate] {
            opacity: 0;
            transform: translateY(24px);
            transition: opacity 0.6s ease, transform 0.6s ease;
            transition-delay: var(--delay, 0ms);
        }
        [data-animate="scale"] {
            transform: scale(0.97);
        }
        [data-animate="fade-left"] {
            transform: translateX(24px);
        }
        [data-animate="fade-right"] {
            transform: translateX(-24px);
        }
        [data-animate].in-view {
            opacity: 1;
            transform: none;
        }

        .page-loader {
            position: fixed;
            inset: 0;
            background: rgba(245, 245, 247, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.3s ease;
        }
        .page-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .page-loader .loader-card {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 45px rgba(0,0,0,0.08);
            text-align: center;
        }
        .page-loader .spinner {
            border: 3px solid #e5e5e5;
            border-top-color: #2563eb;
            border-radius: 999px;
            width: 36px;
            height: 36px;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.75rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal-overlay {
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="antialiased min-h-screen pb-10" style="overflow-x: hidden;">

<div id="initialLoader" class="page-loader">
    <div class="loader-card">
        <div class="spinner"></div>
        <p class="text-sm font-medium text-gray-900">Syncing data...</p>
        <p class="text-xs text-gray-500 mt-1">Please wait while we load your dashboard.</p>
    </div>
</div>

<div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl transform translate-x-full transition-transform duration-300 z-[9999] flex items-center gap-3">
    <i class="fas fa-info-circle"></i>
    <span id="toastMsg">Notification</span>
</div>

<header class="bg-white border-b border-gray-200 sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <img src="./assets/img/blue-logo.png" alt="Logo" class="w-8 h-8">
            <h1 id="headerBusinessName" class="font-bold text-xl tracking-tight text-blue-600"></h1>
        </div>
        <div class="flex items-center gap-5">
            <div class="text-sm text-gray-500 hidden sm:block" id="backupTime">Last sync: Just now</div>
            <a href="./settings.html" class="text-gray-400 hover:text-blue-600 transition" title="Settings">
                <i class="fas fa-cog text-lg"></i>
            </a>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 flex flex-col justify-between h-48 overflow-hidden" data-animate="scale" style="--delay:0ms">
            <div>
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Today's Revenue</div>
                <div class="flex flex-col gap-1" id="statTodayRevenue">
                    <div class="text-2xl font-bold text-gray-900" id="statTodayRevenueValue">₦0.00</div>
                    <div class="text-xs font-medium px-2 py-1 rounded-full bg-gray-100 inline-block w-fit" id="statTodayBadge">Loading...</div>
                </div>
            </div>
            <div class="h-16 w-full relative">
                <canvas id="chartToday"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 flex flex-col justify-between h-48 overflow-hidden" data-animate="scale" style="--delay:80ms">
            <div>
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">This Month Revenue</div>
                <div class="flex flex-col gap-1" id="statMonthRev">
                    <div class="text-2xl font-bold text-gray-900" id="statMonthRevValue">₦0.00</div>
                    <div class="text-xs font-medium px-2 py-1 rounded-full bg-gray-100 inline-block w-fit" id="statMonthBadge">Loading...</div>
                </div>
            </div>
            <div class="h-24 w-full relative overflow-hidden">
                <canvas id="chartMonth"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 flex flex-col justify-between h-48 overflow-hidden" data-animate="scale" style="--delay:160ms">
            <div>
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Yearly Revenue</div>
                <div class="flex flex-col gap-1" id="statYearRev">
                    <div class="text-2xl font-bold text-gray-900" id="statYearRevValue">₦0.00</div>
                    <div class="text-xs font-medium px-2 py-1 rounded-full bg-gray-100 inline-block w-fit" id="statYearBadge">Loading...</div>
                </div>
            </div>
            <div class="h-16 w-full relative overflow-hidden">
                <canvas id="chartYear"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 flex flex-col justify-between h-48 overflow-hidden" data-animate="scale" style="--delay:240ms">
            <div>
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Total Customers</div>
                <div class="flex items-end justify-between">
                    <div class="text-2xl font-bold text-gray-900" id="statTotalCustomers">0</div>
                    <div class="text-xs font-medium text-orange-600">Lifetime</div>
                </div>
            </div>
            <div class="h-16 w-full relative overflow-hidden">
                <canvas id="chartCustomers"></canvas>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100" data-animate="fade-up" style="--delay:0ms">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Today's Profit</div>
            <div class="text-2xl font-bold text-gray-900 mb-1" id="statTodayProfit">₦0.00</div>
            <div class="text-[11px] font-medium px-2 py-1 rounded-full w-fit" id="statProfitBadge">Calculating...</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100" data-animate="fade-up" style="--delay:80ms">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Today's Expenses</div>
            <div class="text-2xl font-bold text-gray-900 mb-1" id="statTodayExpenses">₦0.00</div>
            <div class="text-xs font-medium px-2 py-1 rounded-full w-fit" id="statTodayExpensesBadge">vs yesterday</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100" data-animate="fade-up" style="--delay:160ms">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">This Month's Expenses</div>
            <div class="text-2xl font-bold text-gray-900 mb-1" id="statMonthExpenses">₦0.00</div>
            <div class="text-xs font-medium px-2 py-1 rounded-full w-fit" id="statMonthExpensesBadge">vs last month</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100" data-animate="fade-up" style="--delay:240ms">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Lifetime Expenses</div>
            <div class="text-2xl font-bold text-gray-900 mb-1" id="statLifetimeExpenses">₦0.00</div>
            <div class="text-xs font-medium text-gray-500">All-time total</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100" data-animate="fade-right">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="font-semibold text-gray-900">Weekly Revenue</h3> 
                    <p class="text-sm text-gray-500" id="weeklyTotalDisplay">₦0.00 this week</p>
                </div>
            </div>
            <div class="bar-container" id="weeklyChart">
                <div class="chart-grid-line" style="bottom: 25%;"></div>
                <div class="chart-grid-line" style="bottom: 50%;"></div>
                <div class="chart-grid-line" style="bottom: 75%;"></div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100" data-animate="fade-left" style="--delay:60ms">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="font-semibold text-gray-900">Yearly Revenue</h3> 
                    <p class="text-sm text-gray-500" id="yearlyTotalDisplay">₦0.00 this year</p>
                </div>
            </div>
            <div class="bar-container" id="yearlyChart">
                <div class="chart-grid-line" style="bottom: 25%;"></div>
                <div class="chart-grid-line" style="bottom: 50%;"></div>
                <div class="chart-grid-line" style="bottom: 75%;"></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100" data-animate="fade-right">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="font-semibold text-gray-900">Weekly Expenses</h3> 
                    <p class="text-sm text-gray-500" id="weeklyExpensesTotalDisplay">₦0.00 this week</p>
                </div>
            </div>
            <div class="bar-container" id="weeklyExpensesChart">
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100" data-animate="fade-left" style="--delay:60ms">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="font-semibold text-gray-900">Yearly Expenses</h3> 
                    <p class="text-sm text-gray-500" id="yearlyExpensesTotalDisplay">₦0.00 this year</p>
                </div>
            </div>
            <div class="bar-container" id="yearlyExpensesChart">
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" data-animate="fade-up" style="--delay:100ms">
        <div class="p-5 border-b border-gray-100">
            <div>
                <h3 class="font-semibold text-gray-900">Service Popularity</h3>
                <p class="text-xs text-gray-500 mt-1">Top services by revenue in the selected date range.</p>
            </div>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
            <div class="h-54 md:h-70 relative">
                <canvas id="servicePopularityChart"></canvas>
            </div>
            <div id="servicePopularityList" class="space-y-3 text-sm">
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" data-animate="fade-up" style="--delay:200ms">
        <div class="p-5 border-b border-gray-100">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h3 class="font-semibold text-gray-900">Customer History</h3>
                    <p class="text-xs text-gray-500 mt-1">View past orders and customer loyalty</p>
                </div>
                <div class="relative w-full sm:w-64">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                    <input type="text" id="customerSearchInput" onkeyup="handleCustomerSearch()" placeholder="Search customers..." class="w-full pl-8 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-500 transition">
                </div>
            </div>
        </div>

        <div class="overflow-x-auto relative ">
            <table class="w-full text-left border-collapse">
                <thead class="sticky top-0 bg-gray-50">
                <tr class="text-gray-500 text-xs uppercase tracking-wider border-b border-gray-100" id="customerTableHeaders">
                    <th class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-100" onclick="handleSort('customers', 'name')" data-sort="name">Customer Name <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                    <th class="px-6 py-3 font-medium">Phone</th>
                    <th class="px-6 py-3 font-medium text-center cursor-pointer hover:bg-gray-100" onclick="handleSort('customers', 'totalOrders')" data-sort="totalOrders">Total Orders <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                    <th class="px-6 py-3 font-medium text-right cursor-pointer hover:bg-gray-100" onclick="handleSort('customers', 'totalSpent')" data-sort="totalSpent">Total Spent <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                    <th class="px-6 py-3 font-medium text-right">Actions</th>
                </tr>
                </thead>
                <tbody id="customerTableBody" class="text-sm divide-y divide-gray-100">
                </tbody>
            </table>
        </div>

        <div class="p-4 border-t border-gray-100 flex justify-between items-center" id="customerPaginationControls">
            <span class="text-xs text-gray-500" id="customerPaginationInfo">Showing 0 of 0</span>
            <div class="flex gap-1">
                <button onclick="changeCustomerPage(-1)" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed" id="customerPrevBtn">Prev</button>
                <span class="px-3 py-1 text-xs text-gray-600" id="customerPageNumbers">Page 1 of 1</span>
                <button onclick="changeCustomerPage(1)" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed" id="customerNextBtn">Next</button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-1 space-y-6 h-fit lg:sticky lg:top-20">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100" data-animate="fade-right">
                <div class="p-5 border-b border-gray-100">
                    <h3 class="font-semibold text-gray-900">New Order</h3>
                    <p class="text-xs text-gray-500 mt-1">Enter details to create record</p>
                </div>
                <form id="orderForm" class="p-5 space-y-4">
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                        <div>
                            <p class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Entry Mode</p>
                            <p class="text-[11px] text-gray-500">Choose if this order is for today or a previous date</p>
                        </div>
                        <div class="flex bg-white border border-gray-200 rounded-full overflow-hidden text-xs font-medium">
                            <button type="button" id="entryModeNew" class="px-3 py-1 bg-gray-900 text-white transition">New Data</button>
                            <button type="button" id="entryModeOld" class="px-3 py-1 text-gray-600 transition">Old Data</button>
                        </div>
                    </div>

                    <div id="formSyncNotice" class="hidden text-[11px] text-amber-600 bg-amber-50 border border-amber-100 px-3 py-2 rounded-lg">
                        Syncing data… you can fill the form but saving will be enabled once we reconnect.
                    </div>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Customer Name</label>
                            <input type="text" id="custName" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition" placeholder="e.g. Musa Ibrahim" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" id="custPhone" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition" placeholder="e.g. 080..." required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Address</label>
                            <input type="text" id="custAddr" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition" placeholder="e.g. No 6 Barnawa" required>
                        </div>

                    <div id="manualDateWrapper" class="hidden space-y-1">
                        <label class="block text-xs font-medium text-gray-700">Order Date &amp; Time</label>
                        <input type="datetime-local" id="manualTimestamp" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition">
                        <p class="text-[11px] text-gray-500">Select the original date/time for this order entry.</p>
                    </div>
                    </div>

                    <div class="border-t border-gray-100 my-3 pt-3">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-semibold text-gray-700">Items</label>
                            <button type="button" onclick="addItemRow('itemContainer')" class="text-xs text-blue-600 hover:text-blue-800 font-medium">+ Add Item</button>
                        </div>
                        <div id="itemContainer" class="space-y-2 max-h-48 overflow-y-auto pr-1">
                        </div>
                    </div>

                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                        <span class="font-medium text-gray-700">Total</span>
                        <span class="font-bold text-lg text-gray-900" id="formTotalDisplay">₦0.00</span>
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button type="submit" class="flex-1 bg-black hover:bg-gray-800 text-white font-medium py-2 rounded-lg text-sm transition">Save Order</button>
                        <button type="button" onclick="resetMainForm()" class="px-4 py-2 border border-gray-200 text-gray-600 rounded-lg text-sm hover:bg-gray-50 transition">Reset</button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100" data-animate="fade-right" style="--delay:100ms">
                <div class="p-5 border-b border-gray-100">
                    <h3 class="font-semibold text-gray-900">Log Expense</h3>
                    <p class="text-xs text-gray-500 mt-1">Record business costs and expenses</p>
                </div>
                <form id="expenseForm" class="p-5 space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Expense Date</label>
                        <input type="date" id="expenseDate" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Description</label>
                        <input type="text" id="expenseDesc" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition" placeholder="e.g. Detergent purchase" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Category</label>
                        <select id="expenseCategory" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition">
                            <option>Supplies</option>
                            <option>Utilities</option>
                            <option>Rent</option>
                            <option>Salary</option>
                            <option>Maintenance</option>
                            <option>Miscellaneous</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Amount</label>
                        <input type="number" id="expenseAmount" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition" placeholder="e.g. 5000" required step="0.01">
                    </div>
                    <div class="pt-2">
                        <button type="submit" class="w-full bg-black hover:bg-gray-800 text-white font-medium py-2 rounded-lg text-sm transition">Save Expense</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100" data-animate="fade-left" style="--delay:100ms">
                <div class="p-5 border-b border-gray-100">
                    <h3 class="font-semibold text-gray-900">Low Stock Alerts</h3>
                    <p class="text-xs text-gray-500 mt-1">Items that need to be restocked soon.</p>
                </div>
                <div id="lowStockList" class="p-5 space-y-2 max-h-60 overflow-y-auto">
                    <!-- Low stock items will be dynamically inserted here -->
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" data-animate="fade-left" style="--delay:150ms ">
                <div class="p-5 border-b border-gray-100">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-gray-900">Inventory Management</h3>
                            <p class="text-xs text-gray-500 mt-1">Track stock levels of supplies like detergent, bags, etc.</p>
                        </div>
                        <a href="./usage-report.html" class="text-xs font-medium text-blue-600 hover:text-blue-800 transition whitespace-nowrap">View Usage Report &rarr;</a>
                    </div>
                </div>
                <form id="inventoryForm" class="p-5 grid grid-cols-1 sm:grid-cols-4 gap-4 items-end border-b border-gray-100">
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Item Name</label>
                        <input type="text" id="inventoryName" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="e.g., Detergent" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Unit</label>
                        <input type="text" id="inventoryUnit" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="e.g., kg, pcs" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Cost per Unit (<span class="currency-symbol">₦</span>)</label>
                        <input type="number" id="inventoryCostPerUnit" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="e.g., 1000" required step="0.01">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Current Stock</label>
                        <input type="number" id="inventoryStock" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="e.g., 10" required step="0.01">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Low Stock At</label>
                        <input type="number" id="inventoryThreshold" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="e.g., 2" required step="0.01">
                    </div>
                    <div class="sm:col-span-4">
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg text-sm transition">Add Inventory Item</button>
                    </div>
                </form>
                <div class="overflow-x-auto relative">
                    <table class="w-full text-left border-collapse">
                        <thead class="sticky top-0 bg-gray-50 z-10">
                            <tr class="text-gray-500 text-xs uppercase tracking-wider border-b border-gray-100" id="inventoryTableHeaders">
                                <th class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-100" onclick="handleSort('inventory', 'name')" data-sort="name">Item <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-100" onclick="handleSort('inventory', 'currentStock')" data-sort="currentStock">Current Stock <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-100" onclick="handleSort('inventory', 'lowStockThreshold')" data-sort="lowStockThreshold">Low Stock At <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-6 py-3 font-medium text-right">Cost/Unit</th>
                                <th class="px-6 py-3 font-medium text-right">Total Usage Cost</th>
                                <th class="px-6 py-3 font-medium text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody" class="text-sm divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-gray-100 flex justify-between items-center" id="inventoryPaginationControls">
                    <span class="text-xs text-gray-500" id="inventoryPaginationInfo">Showing 0 of 0</span>
                    <div class="flex gap-1">
                        <button onclick="changeInventoryPage(-1)" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed" id="inventoryPrevBtn">Prev</button>
                        <span class="px-3 py-1 text-xs text-gray-600" id="inventoryPageNumbers">Page 1 of 1</span>
                        <button onclick="changeInventoryPage(1)" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed" id="inventoryNextBtn">Next</button>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-100 flex justify-end items-center">
                    <span class="text-sm font-semibold text-gray-700 mr-2">Total Inventory Usage Expenses:</span>
                    <span class="text-sm font-bold text-red-600" id="totalInventoryUsageExpenses">₦0.00</span>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" data-animate="fade-left" style="--delay:50ms">                <div class="p-5 border-b border-gray-100">
                    <h3 class="font-semibold text-gray-900">Service & Pricing Management</h3>
                    <p class="text-xs text-gray-500 mt-1">Add, edit, or remove the services you offer.</p>
                </div>
                <form id="serviceForm" class="p-5 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end border-b border-gray-100">
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Service Name</label>
                        <input type="text" id="serviceName" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="e.g., Shirt - Wash & Iron" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Price (<span class="currency-symbol">₦</span>)</label>
                        <input type="number" id="servicePrice" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="e.g., 500" required step="0.01">
                    </div>
                    <div class="sm:col-span-3">
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg text-sm transition">Add Service</button>
                    </div>
                </form>
                <div class="overflow-x-auto relative max-h-80">
                    <table class="w-full text-left border-collapse">
                        <tbody id="servicesTableBody" class="text-sm divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-gray-100 flex justify-between items-center" id="servicePaginationControls">
                    <span class="text-xs text-gray-500" id="servicePaginationInfo">Showing 0 of 0</span>
                    <div class="flex gap-1">
                        <button onclick="changeServicePage(-1)" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed" id="servicePrevBtn">Prev</button>
                        <span class="px-3 py-1 text-xs text-gray-600" id="servicePageNumbers">Page 1 of 1</span>
                        <button onclick="changeServicePage(1)" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed" id="serviceNextBtn">Next</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" data-animate="fade-left">
                <div class="p-5 border-b border-gray-100">
                    <h3 class="font-semibold text-gray-900">Recent Expenses</h3>
                    <p class="text-xs text-gray-500 mt-1">A log of the most recent business costs</p>
                </div>
                <div class="overflow-x-auto relative">
                    <table class="w-full text-left border-collapse">
                        <thead>
                        <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-100" id="expenseTableHeaders">
                            <th class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-100" onclick="handleSort('expenses', 'date')" data-sort="date">Date <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-100" onclick="handleSort('expenses', 'description')" data-sort="description">Description <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-100" onclick="handleSort('expenses', 'category')" data-sort="category">Category <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-6 py-3 font-medium text-right cursor-pointer hover:bg-gray-100" onclick="handleSort('expenses', 'amount')" data-sort="amount">Amount <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-6 py-3 font-medium text-right">Actions</th>
                        </tr>
                        </thead>
                        <tbody id="expenseTableBody" class="text-sm divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-gray-100 flex justify-between items-center" id="expensePaginationControls">
                    <span class="text-xs text-gray-500" id="expensePaginationInfo">Showing 0 of 0</span>
                    <div class="flex items-center gap-2">
                        <a href="#" class="text-xs text-blue-600 font-medium hover:underline">View All</a>
                        <button onclick="changeExpensePage(-1)" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed" id="expensePrevBtn">Prev</button>
                        <span class="px-3 py-1 text-xs text-gray-600" id="expensePageNumbers">Page 1 of 1</span>
                        <button onclick="changeExpensePage(1)" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs disabled:opacity-50 disabled:cursor-not-allowed" id="expenseNextBtn">Next</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100" data-animate="fade-left" style="--delay:80ms">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                    <div>
                        <h3 class="font-semibold text-gray-900">Filter Records</h3>
                        <p class="text-xs text-gray-500">Select date range to analyze</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex bg-gray-100 p-1 rounded-lg date-filter">
                            <button onclick="setDateFilter('today')" class="px-3 py-1 text-xs font-medium rounded-md hover:bg-white hover:shadow-sm transition text-gray-600">Today</button>
                            <button onclick="setDateFilter('week')" class="px-3 py-1 text-xs font-medium rounded-md hover:bg-white hover:shadow-sm transition text-gray-600">Last 7 Days</button>
                            <button onclick="setDateFilter('month')" class="px-3 py-1 text-xs font-medium rounded-md hover:bg-white hover:shadow-sm transition text-gray-600">Month</button>
                            <button onclick="setDateFilter('all')" class="px-3 py-1 text-xs font-medium rounded-md bg-white shadow-sm text-gray-900">All Time</button>
                        </div>
                        <button onclick="openProfitLossModal()" class="px-3 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg text-sm hover:bg-gray-50 transition" title="Profit & Loss Report"><i class="fas fa-chart-line text-green-600"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Start Date</label>
                        <input type="date" id="filterStart" class="w-full text-sm border-gray-200 rounded-md border p-2">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">End Date</label>
                        <input type="date" id="filterEnd" class="w-full text-sm border-gray-200 rounded-md border p-2">
                    </div>
                    <div class="col-span-2 md:col-span-2 flex items-end">
                        <button onclick="applyDateFilter()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 rounded-md transition">Apply Filter</button>
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 flex justify-between items-center text-sm text-blue-800">
                    <span>Range Stats:</span>
                    <div class="font-semibold">
                        <span id="rangeOrders">0</span> Orders | <span id="rangeIncome">₦0.00</span> Income
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" data-animate="fade-left" style="--delay:140ms">
                <div class="p-5 border-b border-gray-100 space-y-3">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div>
                            <h3 class="font-semibold text-gray-900">Order Records</h3>
                            <p class="text-xs text-gray-500 mt-1">Export filtered records to CSV</p>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <div class="relative flex-grow sm:flex-grow-0 sm:w-64">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                                <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Search Name, Date, Amount..." class="w-full pl-8 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-500 transition">
                            </div>
                            <button onclick="exportFullReport()" class="px-3 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg text-sm hover:bg-gray-50 transition" title="Export Revenue & Expenses"><i class="fas fa-file-excel text-green-600"></i></button>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 text-xs font-medium">
                        <button type="button" class="px-3 py-1 rounded-full border border-gray-200 text-gray-600 bg-white status-filter-btn"
                                data-status="all" onclick="setStatusFilter('all')">All</button>
                        <button type="button" class="px-3 py-1 rounded-full border border-gray-200 text-gray-600 bg-white status-filter-btn"
                                data-status="pending" onclick="setStatusFilter('pending')">Pending</button>
                        <button type="button" class="px-3 py-1 rounded-full border border-gray-200 text-gray-600 bg-white status-filter-btn"
                                data-status="in_progress" onclick="setStatusFilter('in_progress')">In Progress</button>
                        <button type="button" class="px-3 py-1 rounded-full border border-gray-200 text-gray-600 bg-white status-filter-btn"
                                data-status="ready" onclick="setStatusFilter('ready')">Ready</button>
                        <button type="button" class="px-3 py-1 rounded-full border border-gray-200 text-gray-600 bg-white status-filter-btn"
                                data-status="delivered" onclick="setStatusFilter('delivered')">Delivered</button>
                    </div>
                </div>

                <div class="sm:hidden text-[11px] text-gray-500 px-5 -mt-3 mb-2">Swipe horizontally to view full details.</div>

                <div class="overflow-x-auto relative">
                    <div class="pointer-events-none absolute inset-y-0 right-0 w-8 bg-gradient-to-l from-white to-transparent hidden sm:block"></div>
                    <table class="w-full text-left border-collapse">
                        <thead>
                        <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-100" id="recordsTableHeaders">
                            <th class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-100" onclick="handleSort('orders', 'date')" data-sort="date">Date <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-100" onclick="handleSort('orders', 'customer')" data-sort="customer">Customer <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-6 py-3 font-medium">Items</th>
                            <th class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-100" onclick="handleSort('orders', 'total')" data-sort="total">Total <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-6 py-3 font-medium text-right">Actions</th>
                        </tr>
                        </thead>
                        <tbody id="recordsTableBody" class="text-sm divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>

                <div class="p-4 border-t border-gray-100 flex justify-between items-center" id="paginationControls">
                    <span class="text-xs text-gray-500" id="paginationInfo">Showing 0 of 0</span>
                    <div class="flex gap-1">
                        <button onclick="changePage(-1)" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs">Prev</button>
                        <button onclick="changePage(1)" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs">Next</button>
                    </div>
                </div>
            </div>
        </div> <!-- This closes lg:col-span-2 -->
    </div> <!-- This closes the main grid -->
</main>

<div id="viewModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-bold text-gray-900">Order Details</h3>
            <button onclick="closeModal('viewModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-6">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600 text-xl">
                    <i class="fas fa-receipt"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900" id="viewTotal">₦0.00</h2>
                <p class="text-sm text-gray-500" id="viewDate">Oct 26, 2025</p>
            </div>

            <div class="space-y-4 mb-6">
                <div class="flex justify-between border-b border-gray-100 pb-2">
                    <span class="text-sm text-gray-500">Customer</span>
                    <span class="text-sm font-medium text-right" id="viewName">-</span>
                </div>
                <div class="flex justify-between border-b border-gray-100 pb-2">
                    <span class="text-sm text-gray-500">Phone</span>
                    <span class="text-sm font-medium text-right" id="viewPhone">-</span>
                </div>
                <div class="flex justify-between border-b border-gray-100 pb-2">
                    <span class="text-sm text-gray-500">Address</span>
                    <span class="text-sm font-medium text-right" id="viewAddress">-</span>
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="text-xs font-semibold text-gray-500 uppercase mb-3">Items Purchased</h4>
                <div id="viewItemsList" class="space-y-2 text-sm">
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-6 py-3 text-right">
            <button onclick="closeModal('viewModal')" class="bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm hover:bg-gray-50">Close</button>
        </div>
    </div>
</div>

<div id="editModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-bold text-gray-900">Edit Order</h3>
            <button onclick="closeModal('editModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-6 overflow-y-auto">
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editOrderId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-medium text-gray-700">Name</label>
                        <input type="text" id="editName" class="w-full border rounded p-2 text-sm mt-1" required>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-700">Phone</label>
                        <input type="text" id="editPhone" class="w-full border rounded p-2 text-sm mt-1" required>
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs font-medium text-gray-700">Address</label>
                        <input type="text" id="editAddress" class="w-full border rounded p-2 text-sm mt-1" required>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-semibold text-gray-700">Edit Items</label>
                        <button type="button" onclick="addItemRow('editItemContainer')" class="text-xs text-blue-600 font-medium">+ Add Row</button>
                    </div>
                    <div id="editItemContainer" class="space-y-2">
                    </div>
                </div>

                <div class="flex justify-between items-center bg-gray-100 p-3 rounded mt-4">
                    <span class="font-medium text-gray-700">New Total</span>
                    <span class="font-bold text-lg text-blue-600" id="editTotalDisplay">₦0.00</span>
                </div>
            </form>
        </div>
        <div class="bg-gray-50 px-6 py-3 text-right flex gap-2 justify-end border-t border-gray-100">
            <button onclick="closeModal('editModal')" class="bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm hover:bg-gray-50">Cancel</button>
            <button onclick="saveEdit()" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-blue-700">Save Changes</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 class="font-bold text-lg text-gray-900 mb-2">Delete Record?</h3>
        <p class="text-sm text-gray-500 mb-6">Are you sure you want to delete this order? This action cannot be undone.</p>
        <div class="flex gap-3 justify-center">
            <button onclick="closeModal('deleteModal')" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 text-sm font-medium hover:bg-gray-50">Cancel</button>
            <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 rounded-lg text-white text-sm font-medium hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>

<div id="customerHistoryModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]">
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-5 text-white flex justify-between items-start">
            <div class="flex-1">
                <h3 class="font-bold text-xl mb-1" id="customerHistoryName">Customer Name</h3>
                <div class="flex gap-4 text-sm text-blue-100">
                    <span><i class="fas fa-phone mr-1"></i><span id="customerHistoryPhone">-</span></span>
                    <span><i class="fas fa-map-marker-alt mr-1"></i><span id="customerHistoryAddress">-</span></span>
                </div>
            </div>
            <button onclick="closeModal('customerHistoryModal')" class="text-white hover:text-blue-100 transition"><i class="fas fa-times text-xl"></i></button>
        </div>

        <div class="grid grid-cols-3 divide-x divide-gray-200 border-b border-gray-100">
            <div class="p-4 text-center">
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Total Orders</div>
                <div class="text-2xl font-bold text-gray-900" id="customerTotalOrders">0</div>
            </div>
            <div class="p-4 text-center">
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Total Spent</div>
                <div class="text-2xl font-bold text-blue-600" id="customerTotalSpent">₦0.00</div>
            </div>
            <div class="p-4 text-center">
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">First Order</div>
                <div class="text-sm font-semibold text-gray-900" id="customerFirstOrder">-</div>
            </div>
        </div>

        <div class="p-6 overflow-y-auto flex-1 bg-gray-50/50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Order History</h4>
                    <div id="customerOrdersList" class="space-y-3">
                    </div>
                </div>
                <div class="md:col-span-1">
                     <h4 class="text-sm font-semibold text-gray-900 mb-3">Customer Notes</h4>
                     <textarea id="customerNotesText" class="w-full h-48 border border-gray-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Add notes about this customer's preferences, allergies, etc."></textarea>
                     <button id="saveCustomerNotesBtn" class="w-full mt-2 bg-gray-800 hover:bg-gray-900 text-white text-xs font-medium py-2 rounded-lg transition">Save Notes</button>
                </div>
            </div>
        </div>


        <div class="bg-gray-50 px-6 py-3 text-right border-t border-gray-100">
            <button onclick="closeModal('customerHistoryModal')" class="bg-white border border-gray-300 text-gray-700 font-medium py-2 px-6 rounded-lg text-sm hover:bg-gray-50 transition">Close</button>
        </div>
    </div>
</div>

<div id="profitLossModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <div>
                <h3 class="font-bold text-gray-900">Profit & Loss Report</h3>
                <p class="text-xs text-gray-500">Analyze revenue against expenses over time.</p>
            </div>
            <button onclick="closeModal('profitLossModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-6 flex-1 overflow-y-auto">
            <div class="flex justify-center mb-4">
                <div id="plDateFilter" class="flex bg-gray-100 p-1 rounded-lg">
                    <button data-period="week" class="px-3 py-1 text-xs font-medium rounded-md hover:bg-white hover:shadow-sm transition text-gray-600">This Week</button>
                    <button data-period="month" class="px-3 py-1 text-xs font-medium rounded-md hover:bg-white hover:shadow-sm transition text-gray-900 bg-white shadow-sm">This Month</button>
                    <button data-period="year" class="px-3 py-1 text-xs font-medium rounded-md hover:bg-white hover:shadow-sm transition text-gray-600">This Year</button>
                </div>
            </div>
            <div class="grid grid-cols-3 divide-x divide-gray-200 border border-gray-200 rounded-lg mb-6">
                <div class="p-4 text-center">
                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Total Revenue</div>
                    <div class="text-2xl font-bold text-green-600" id="plRevenue">₦0.00</div>
                </div>
                <div class="p-4 text-center">
                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Total Expenses</div>
                    <div class="text-2xl font-bold text-red-600" id="plExpenses">₦0.00</div>
                </div>
                <div class="p-4 text-center">
                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Net Profit</div>
                    <div class="text-2xl font-bold text-blue-600" id="plProfit">₦0.00</div>
                </div>
            </div>
            <div class="h-64"><canvas id="plChart"></canvas></div>
        </div>
    </div>
</div>

<div id="editExpenseModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-bold text-gray-900">Edit Expense</h3>
            <button onclick="closeModal('editExpenseModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-6 overflow-y-auto">
            <form id="editExpenseForm" class="space-y-4">
                <input type="hidden" id="editExpenseId">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Expense Date</label>
                    <input type="date" id="editExpenseDate" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Description</label>
                    <input type="text" id="editExpenseDesc" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Category</label>
                    <select id="editExpenseCategory" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                        <option>Supplies</option>
                        <option>Utilities</option>
                        <option>Rent</option>
                        <option>Salary</option>
                        <option>Maintenance</option>
                        <option>Miscellaneous</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Amount</label>
                    <input type="number" id="editExpenseAmount" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" required step="0.01">
                </div>
            </form>
        </div>
        <div class="bg-gray-50 px-6 py-3 text-right flex gap-2 justify-end border-t border-gray-100">
            <button onclick="closeModal('editExpenseModal')" class="bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm hover:bg-gray-50">Cancel</button>
            <button onclick="saveExpenseEdit()" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-blue-700">Save Changes</button>
        </div>
    </div>
</div>

<div id="restockModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
        <div class="p-6">
            <h3 class="font-bold text-lg text-gray-900 mb-2">Restock Item</h3>
            <p class="text-sm text-gray-500 mb-4">Add new stock for <span id="restockItemName" class="font-semibold"></span>.</p>
            <form id="restockForm">
                <label class="block text-xs font-medium text-gray-700 mb-1">Quantity to Add</label>
                <input type="number" id="restockQuantity" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" required step="0.01" placeholder="e.g. 5">
            </form>
        </div>
        <div class="bg-gray-50 px-6 py-3 flex gap-3 justify-end rounded-b-xl">
            <button onclick="closeModal('restockModal')" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 text-sm font-medium hover:bg-gray-50">Cancel</button>
            <button onclick="saveRestock()" class="px-4 py-2 bg-blue-600 rounded-lg text-white text-sm font-medium hover:bg-blue-700">Add Stock</button>
        </div>
    </div>
</div>

<div id="usageModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
        <div class="p-6">
            <h3 class="font-bold text-lg text-gray-900 mb-2">Log Item Usage</h3>
            <p class="text-sm text-gray-500 mb-4">Record usage for <span id="usageItemName" class="font-semibold"></span>.</p>
            <form id="usageForm" class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Quantity Used</label>
                    <input type="number" id="usageQuantity" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" required step="0.01" placeholder="e.g. 0.5">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Usage Notes (Optional)</label>
                    <input type="text" id="usageNotes" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="e.g. For a large order">
                </div>
            </form>
        </div>
        <div class="bg-gray-50 px-6 py-3 flex gap-3 justify-end rounded-b-xl">
            <button onclick="closeModal('usageModal')" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 text-sm font-medium hover:bg-gray-50">Cancel</button>
            <button onclick="saveUsage()" class="px-4 py-2 bg-orange-600 rounded-lg text-white text-sm font-medium hover:bg-orange-700">Log Usage</button>
        </div>
    </div>
</div>

<div id="editInventoryModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-bold text-gray-900">Edit Inventory Item</h3>
            <button onclick="closeModal('editInventoryModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-6">
            <form id="editInventoryForm" class="space-y-4">
                <input type="hidden" id="editInventoryId">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Item Name</label>
                    <input type="text" id="editInventoryName" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Low Stock Threshold</label>
                    <input type="number" id="editInventoryThreshold" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" required step="0.01">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Cost per Unit (<span class="currency-symbol">₦</span>)</label>
                    <input type="number" id="editInventoryCostPerUnit" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" required step="0.01">
                </div>
            </form>
        </div>
        <div class="bg-gray-50 px-6 py-3 text-right flex gap-2 justify-end border-t border-gray-100">
            <button onclick="closeModal('editInventoryModal')" class="bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm hover:bg-gray-50">Cancel</button>
            <button onclick="saveInventoryEdit()" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-blue-700">Save Changes</button>
        </div>
    </div>
</div>

<div id="editServiceModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-bold text-gray-900">Edit Service</h3>
            <button onclick="closeModal('editServiceModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-6">
            <form id="editServiceForm" class="space-y-4">
                <input type="hidden" id="editServiceId">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Service Name</label>
                    <input type="text" id="editServiceName" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Price</label>
                    <input type="number" id="editServicePrice" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" required step="0.01">
                </div>
            </form>
        </div>
        <div class="bg-gray-50 px-6 py-3 text-right flex gap-2 justify-end border-t border-gray-100">
            <button onclick="closeModal('editServiceModal')" class="bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm hover:bg-gray-50">Cancel</button>
            <button onclick="saveServiceEdit()" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-blue-700">Save Changes</button>
        </div>
    </div>
</div>


<script>
    /*******************************
     * 1. FIREBASE SETUP (v8 style)
     *******************************/
        // IMPORTANT: Go to Google Cloud Console > APIs & Services > Credentials
        // Edit this API Key and add "HTTP Referrer" restrictions to your specific domain(s)
        // to prevent unauthorized use.
    const firebaseConfig = {
            apiKey: "AIzaSyCGBqbJk546uJChQUrIUUIaXt20FOpnyr8",
            authDomain: "laundry-management-b5198.firebaseapp.com",
            projectId: "laundry-management-b5198",
            storageBucket: "laundry-management-b5198.firebasestorage.app",
            messagingSenderId: "253804986338",
            appId: "1:253804986338:web:464940df509269255803bb",
            measurementId: "G-4YWV9LGJSR"
        };

    // Initialize Firebase (v8)
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();


    /*******************************
     * 2. STATE MANAGEMENT
     *******************************/
    let currentUser = null;
    let allExpenses = [];
    let allOrders = [];
    let allServices = []; // NEW: Cache for all services
    let filteredOrders = [];
    let currentPage = 1;
    let currentExpensePage = 1;
    const expensesPerPage = 5;
    const rowsPerPage = 5;
    let currentServicePage = 1;
    const servicesPerPage = 3;

    let allInventory = [];
    let currentInventoryPage = 1;
    const inventoryPerPage = 5;
    let usageTargetId = null;
    let restockTargetId = null;

    let deleteTargetId = null;
    let deleteTargetType = 'order'; // 'order' or 'expense'
    let dataReady = false;
    let entryMode = 'new';
    let currentStatusFilter = 'all';

    let appSettings = { businessName: 'Bumba Businesses Ventures', currencyCode: 'NGN' }; // Default settings
    let chartInstances = {}; // Chart.js instances

    let sortState = {
        orders: { column: 'date', direction: 'desc' },
        customers: { column: 'totalSpent', direction: 'desc' },
        expenses: { column: 'date', direction: 'desc' },
        services: { column: 'name', direction: 'asc' },
        inventory: { column: 'name', direction: 'asc' }
    };


    /*******************************
     * 3. INITIALIZATION
     *******************************/
    async function init() {

        // Firestore debug log level
        firebase.firestore.setLogLevel("debug");

        // Authenticate
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await auth.signInWithCustomToken(__initial_auth_token);
        } else {
            await auth.signInAnonymously();
        }

        // Auth listener
        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;

                setupRealtimeListener();
                setupExpenseListener();
                setupServicesListener(); // NEW: Fetch services on startup
                setupInventoryListener(); // NEW: Fetch inventory on startup
                setupSettingsListener(); // NEW: Fetch app settings
            }
        });
    }
    
    function onDataReady() {
        setLoadingState(false); // Hide the main loader
        setFormInteractive(true); // Enable the form
        addItemRow("itemContainer"); // Initialize first item row

        // Now that the app is "ready", perform the first full render of the UI
        setDateFilter('all'); // Set the initial filter state
        calculateStats();
        updateCustomerTable();
        renderExpenseTable();
        renderServicesTable();
        updateAllServiceDropdowns();
        renderInventoryTable();
        updateLowStockList();
    }


    /*******************************
     * 4. FIRESTORE HELPERS
     *******************************/
    function getOrdersCollectionRef() {
        return db
            .collection("artifacts")
            .doc(firebaseConfig.appId)
            .collection("public")
            .doc("data")
            .collection("orders");
    }

    function getExpensesCollectionRef() {
        return db
            .collection("artifacts")
            .doc(firebaseConfig.appId)
            .collection("public")
            .doc("data")
            .collection("expenses");
    }
    
    function getServicesCollectionRef() {
        return db.collection("artifacts").doc(firebaseConfig.appId).collection("public").doc("data").collection("services");
    }

    function getInventoryCollectionRef() {
        return db.collection("artifacts").doc(firebaseConfig.appId).collection("public").doc("data").collection("inventory");
    }

    function getInventoryUsageCollectionRef() {
        return db.collection("artifacts").doc(firebaseConfig.appId).collection("public").doc("data").collection("inventory_usage");
    }


    function getCustomerNotesCollectionRef() {
        return db
            .collection("artifacts")
            .doc(firebaseConfig.appId)
            .collection("public")
            .doc("data")
            .collection("customer_notes");
    }

    function getSettingsDocRef() {
        return db.collection("artifacts").doc(firebaseConfig.appId).collection("public").doc("data").collection("config").doc("app_settings");
    }

    /*******************************
     * 5. REALTIME DATA LISTENER
     *******************************/
    function setupRealtimeListener() {
        const collectionRef = getOrdersCollectionRef();

        collectionRef
            .orderBy("createdAt", "desc")
            .onSnapshot(
                snapshot => {
                    // ALWAYS just update the data array first.
                    allOrders = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const timestamp =
                            data.timestamp instanceof firebase.firestore.Timestamp
                                ? data.timestamp.toDate().toISOString()
                                : data.timestamp;
                        const status = data.status || "pending";
                        allOrders.push({ id: doc.id, ...data, status, timestamp });
                    });

                    // If this is the FIRST time data is loaded, set the ready flag
                    // and call the master render function.
                    if (!dataReady) {
                        dataReady = true;
                        onDataReady(); // This function now handles all initial rendering
                    } else {
                        // For any subsequent data changes, just re-render the affected parts.
                        applyDateFilter();
                        calculateStats();
                        updateCustomerTable();
                    }

                    updateLastSyncTime();
                    showToast("Data Synced", "success");
                },
                error => {
                    console.error("Error fetching data:", error);
                    setLoadingState(false); // Hide loader on error
                    showToast("Sync Error", "error");
                }
            );
    }

    function setupExpenseListener() {
        getExpensesCollectionRef().orderBy("expenseDate", "desc").onSnapshot(snapshot => {
            allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (dataReady) {
                renderExpenseTable();
                calculateStats(); // Recalculate stats as expenses affect profit
                showToast("Expenses Synced", "info");
            }
        }, error => {
            console.error("Error fetching expenses:", error);
            showToast("Expense Sync Error", "error");
        });
    }

    function setupServicesListener() {
        getServicesCollectionRef().orderBy('name').onSnapshot(snapshot => {
            allServices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // Defer initial render until onDataReady has fired
            if (dataReady) {
                renderServicesTable();
                updateAllServiceDropdowns();
                showToast("Services list updated", "info");
            }
        }, error => {
            console.error("Error fetching services:", error);
            showToast("Could not load services list.", "error");
        });
    }

    function setupInventoryListener() {
        getInventoryCollectionRef().orderBy('name').onSnapshot(snapshot => {
            allInventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (dataReady) {
                renderInventoryTable();
                updateLowStockList();
                showToast("Inventory list updated", "info");
            }
        }, error => {
            console.error("Error fetching inventory:", error);
            showToast("Could not load inventory list.", "error");
        });
    }

    function setupSettingsListener() {
        getSettingsDocRef().onSnapshot(doc => {
            if (doc.exists) {
                appSettings = doc.data();
                // Apply settings across the UI
                if (!dataReady) {
                    // If the main data isn't ready, just update the currency symbols and stop.
                    // The main data listener will handle the full render.
                    updateCurrencyDisplays();
                    return;
                }
                document.getElementById('headerBusinessName').textContent = appSettings.businessName || 'Laundry Dashboard';
                // Re-calculate stats to update currency formats
                if (dataReady) { // This check ensures we only do a full re-render on subsequent updates, not the initial load.
                    updateCurrencyDisplays(); // NEW: Update all currency symbols
                    updateAllServiceDropdowns(); // Update dropdowns with new currency format
                    renderServicesTable(); // Re-render services with new currency
                    renderExpenseTable(); // Re-render expenses with new currency
                    renderTable(getFilteredSearchResults()); // Re-render orders with new currency
                    updateCustomerTable(); // Re-render customer list with new currency
                    document.getElementById('formTotalDisplay').textContent = formatCurrency(0, true); // Re-render the new order form total
                    calculateStats();
                    showToast("Settings updated.", "info");
                }
            }
        }, error => {
            console.error("Error fetching settings:", error);
        });
    }

    function updateCurrencyDisplays() {
        const currencyCode = appSettings.currencyCode || 'NGN';
        let symbol = '₦'; // Default
        try {
            // Use Intl.NumberFormat to get the currency symbol
            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: currencyCode, currencyDisplay: 'narrowSymbol' });
            const parts = formatter.formatToParts(1);
            symbol = parts.find(p => p.type === 'currency')?.value || currencyCode;
        } catch (e) {
            symbol = currencyCode; // Fallback to code if symbol lookup fails
        }

        document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = symbol);
    }

    function updateAllServiceDropdowns() {
        // Generate the options string once
        let serviceOptions = '<option value="" data-price="0">Select a service...</option>'; // The price here is always in NGN
        allServices.sort((a, b) => a.name.localeCompare(b.name)).forEach(service => {
            serviceOptions += `<option value="${escapeHtml(service.name)}" data-price="${service.price}">${escapeHtml(service.name)} - ${formatCurrency(service.price, true)}</option>`;
        });

        // Find all service dropdowns in both the main form and the edit modal
        const allDropdowns = document.querySelectorAll('#itemContainer .item-desc, #editItemContainer .item-desc');

        allDropdowns.forEach(select => {
            // Preserve the currently selected value if it still exists
            const currentValue = select.value;
            select.innerHTML = serviceOptions;
            if (allServices.some(s => s.name === currentValue)) {
                select.value = currentValue;
            }
        });
    }

    function handleSort(table, column) {
        if (sortState[table].column === column) {
            sortState[table].direction = sortState[table].direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState[table].column = column;
            sortState[table].direction = 'asc'; // Default to ascending on new column
        }

        // Re-render the appropriate table
        switch (table) {
            case 'orders': renderTable(getFilteredSearchResults()); break;
            case 'customers': renderCustomerTable(); break;
            case 'expenses': renderExpenseTable(); break;
            case 'services': renderServicesTable(); break;
            case 'inventory': renderInventoryTable(); break;
        }
    }

    function updateSortIndicators(table, containerId) {
        const headers = document.querySelectorAll(`#${containerId} th[data-sort]`);
        headers.forEach(th => {
            const column = th.dataset.sort;
            const icon = th.querySelector('i');
            if (icon) {
                if (sortState[table].column === column) {
                    icon.className = `fas ${sortState[table].direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down'} ml-1`;
                } else {
                    icon.className = 'fas fa-sort text-gray-300 ml-1';
                }
            }
        });
    }

    function renderServicesTable() {
        const tbody = document.getElementById('servicesTableBody');
        if (!tbody) return;
        const wasEmpty = allServices.length === 0;
        tbody.innerHTML = '';

        const totalPages = Math.ceil(allServices.length / servicesPerPage);

        // Sorting logic
        const sortKey = sortState.services.column;
        const sortDir = sortState.services.direction === 'asc' ? 1 : -1;
        const sortedData = [...allServices].sort((a, b) => {
            const valA = sortKey === 'price' ? a.price : a.name.toLowerCase();
            const valB = sortKey === 'price' ? b.price : b.name.toLowerCase();
            if (valA < valB) return -1 * sortDir;
            if (valA > valB) return 1 * sortDir;
            return 0;
        });

        const start = (currentServicePage - 1) * servicesPerPage;
        const end = start + servicesPerPage;
        const pageData = sortedData.slice(start, end);

        // No headers to update for this table, but we could add them if needed.

        if (pageData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500 text-xs">No services defined yet.</td></tr>`;
            document.getElementById('servicePaginationInfo').textContent = 'Showing 0 of 0';
            document.getElementById('servicePageNumbers').textContent = 'Page 0 of 0';
            updateServicePaginationButtons(0, 0);
            return;
        }

        pageData.forEach(service => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 transition';
            if (wasEmpty) {
                // Adjust max-height of the table container if it was previously empty
                const tableContainer = document.querySelector('#servicesTableBody').closest('.max-h-60');
                if (tableContainer) tableContainer.style.maxHeight = 'none';
            }

            tr.innerHTML = `
                <td class="px-6 py-3 font-medium text-gray-800">${escapeHtml(service.name)}</td>
                <td class="px-6 py-3 font-semibold text-gray-600 text-right">${formatCurrency(service.price, true)}</td>
                <td class="px-6 py-3 text-right">
                    <button onclick='openEditService("${service.id}")' class="p-2 text-sm text-orange-500 hover:bg-orange-50 rounded transition" title="Edit"><i class="fas fa-edit"></i></button>
                    <button onclick='openDelete("${service.id}", "service")' class="p-2 text-sm text-red-500 hover:bg-red-50 rounded transition" title="Delete"><i class="fas fa-trash-alt"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('servicePaginationInfo').textContent = `Showing ${start + 1} to ${Math.min(end, allServices.length)} of ${allServices.length}`;
        document.getElementById('servicePageNumbers').textContent = `Page ${currentServicePage} of ${totalPages}`;
        updateServicePaginationButtons(currentServicePage, totalPages);
    }

    function updateServicePaginationButtons(currentPage, totalPages) {
        const prevBtn = document.getElementById('servicePrevBtn');
        const nextBtn = document.getElementById('serviceNextBtn');

        if (prevBtn && nextBtn) {
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }
    }

    function changeServicePage(delta) {
        const totalPages = Math.ceil(allServices.length / servicesPerPage);
        const newPage = currentServicePage + delta;

        if (newPage >= 1 && newPage <= totalPages) {
            currentServicePage = newPage;
            renderServicesTable();
        }
    }

    document.getElementById('serviceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';

        try {
            const name = document.getElementById('serviceName').value.trim();
            const price = parseFloat(document.getElementById('servicePrice').value);

            if (!name || isNaN(price)) throw new Error("Service name and price are required.");
            if (price < 0) throw new Error("Price cannot be negative.");

            const serviceData = { name, price };

            // Check for duplicates
            if (allServices.some(s => s.name.toLowerCase() === name.toLowerCase())) {
                throw new Error(`Service "${name}" already exists.`);
            }

            await getServicesCollectionRef().add(serviceData);
            showToast("Service added!", "success");
            e.target.reset();
        } catch (err) {
            showToast(err.message, "error");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Service';
        }
    });

    function openEditService(id) {
        const service = allServices.find(s => s.id === id);
        if (!service) return;

        document.getElementById('editServiceId').value = id;
        document.getElementById('editServiceName').value = service.name;
        document.getElementById('editServicePrice').value = convertFromNgn(service.price).toFixed(2);

        document.getElementById('editServiceModal').classList.remove('hidden');
    }

    async function saveServiceEdit() {
        const id = document.getElementById('editServiceId').value;
        const name = document.getElementById('editServiceName').value.trim();
        let price = parseFloat(document.getElementById('editServicePrice').value);

        if (!id || !name || isNaN(price)) {
            showToast("Name and Price are required.", "error");
            return;
        }

        // Check for duplicates, excluding the current item being edited
        if (allServices.some(s => s.id !== id && s.name.toLowerCase() === name.toLowerCase())) {
            showToast(`Another service with the name "${name}" already exists.`, "error");
            return;
        }

        // Convert the price back to NGN before saving
        const priceInNgn = convertToNgn(price);

        const updatedData = { name, price: priceInNgn };

        try {
            await getServicesCollectionRef().doc(id).update(updatedData);
            closeModal('editServiceModal');
            showToast("Service Updated", "success");
        } catch (err) {
            console.error("[Update Service]", err);
            showToast("Update Failed", "error");
        }
    }

    /*******************************
     * INVENTORY LOGIC
     *******************************/
    document.getElementById('inventoryForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';

        try {
            const name = document.getElementById('inventoryName').value.trim();
            const unit = document.getElementById('inventoryUnit').value.trim();
            const currentStock = parseFloat(document.getElementById('inventoryStock').value);
            const lowStockThreshold = parseFloat(document.getElementById('inventoryThreshold').value);
            const costPerUnit = parseFloat(document.getElementById('inventoryCostPerUnit').value);

            if (!name || !unit || isNaN(currentStock) || isNaN(lowStockThreshold) || isNaN(costPerUnit)) throw new Error("All fields are required.");
            if (currentStock < 0 || lowStockThreshold < 0 || costPerUnit < 0) throw new Error("Stock, threshold, and cost per unit cannot be negative.");

            // Check for duplicates
            if (allInventory.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                throw new Error(`Item "${name}" already exists in inventory.`);
            }

            const inventoryData = {
                name,
                unit,
                currentStock,
                lowStockThreshold,
                costPerUnit,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            await getInventoryCollectionRef().add(inventoryData);
            showToast("Inventory item added!", "success");
            e.target.reset();
        } catch (err) {
            showToast(err.message, "error");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Inventory Item';
        }
    });

    function renderInventoryTable() {
        const tbody = document.getElementById('inventoryTableBody');
        if (!tbody) return;
        tbody.innerHTML = '';

        // Calculate total usage costs for each inventory item
        const inventoryUsageCosts = {};
        let grandTotalInventoryUsageExpenses = 0;
        allExpenses.forEach(expense => {
            if (expense.inventoryItemId) {
                if (!inventoryUsageCosts[expense.inventoryItemId]) {
                    inventoryUsageCosts[expense.inventoryItemId] = 0;
                }
                inventoryUsageCosts[expense.inventoryItemId] += expense.amount;
                grandTotalInventoryUsageExpenses += expense.amount;
            }
        });

        // Sorting logic
        const sortKey = sortState.inventory.column;
        const sortDir = sortState.inventory.direction === 'asc' ? 1 : -1;
        const sortedData = [...allInventory].sort((a, b) => {
            const valA = typeof a[sortKey] === 'string' ? a[sortKey].toLowerCase() : a[sortKey];
            const valB = typeof b[sortKey] === 'string' ? b[sortKey].toLowerCase() : b[sortKey];
            if (valA < valB) return -1 * sortDir;
            if (valA > valB) return 1 * sortDir;
            return 0;
        });

        const totalPages = Math.ceil(allInventory.length / inventoryPerPage);
        const start = (currentInventoryPage - 1) * inventoryPerPage;
        const end = start + inventoryPerPage;
        const pageData = sortedData.slice(start, end);

        // Update sort indicators
        updateSortIndicators('inventory', 'inventoryTableHeaders');

        if (pageData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 text-xs">No inventory items added yet.</td></tr>`;
            document.getElementById('inventoryPaginationInfo').textContent = 'Showing 0 of 0';
            document.getElementById('inventoryPageNumbers').textContent = 'Page 0 of 0';
            updateInventoryPaginationButtons(0, 0);
            document.getElementById('totalInventoryUsageExpenses').textContent = formatCurrency(0, true);
            return;
        }

        pageData.forEach(item => {
            const isLow = item.currentStock <= item.lowStockThreshold;
            const itemTotalUsageCost = inventoryUsageCosts[item.id] || 0;
            const tr = document.createElement('tr');
            tr.className = `hover:bg-gray-50 transition ${isLow ? 'bg-red-50' : ''}`;
            tr.innerHTML = `
                <td class="px-6 py-3 font-medium text-gray-800">${escapeHtml(item.name)}</td>
                <td class="px-6 py-3 font-semibold ${isLow ? 'text-red-600' : 'text-gray-700'}">
                    ${item.currentStock} ${escapeHtml(item.unit)}
                    ${isLow ? '<span class="ml-2 text-xs font-bold text-red-500">(LOW)</span>' : ''}
                </td>
                <td class="px-6 py-3 text-gray-500">${item.lowStockThreshold} ${escapeHtml(item.unit)}</td>
                <td class="px-6 py-3 text-right text-gray-700">${formatCurrency(item.costPerUnit || 0, true)}</td>
                <td class="px-6 py-3 text-right font-semibold text-red-600">${formatCurrency(itemTotalUsageCost, true)}</td>
                <td class="px-6 py-3 text-right">
                    <button onclick='openUsage("${item.id}")' class="px-3 py-1.5 text-sm text-white bg-orange-500 hover:bg-orange-600 rounded-md transition" title="Log Usage"><i class="fas fa-minus-circle mr-1"></i> Use</button>
                    <button onclick='openRestock("${item.id}")' class="px-3 py-1.5 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-md transition" title="Restock"><i class="fas fa-plus-circle mr-1"></i> Restock</button>
                    <button onclick='openEditInventory("${item.id}")' class="p-2 text-sm text-orange-500 hover:bg-orange-50 rounded-md transition" title="Edit"><i class="fas fa-edit"></i></button>
                    <button onclick='openDelete("${item.id}", "inventory")' class="p-2 text-sm text-red-500 hover:bg-red-50 rounded-md transition" title="Delete"><i class="fas fa-trash-alt"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('inventoryPaginationInfo').textContent = `Showing ${start + 1} to ${Math.min(end, allInventory.length)} of ${allInventory.length}`;
        document.getElementById('inventoryPageNumbers').textContent = `Page ${currentInventoryPage} of ${totalPages}`;
        updateInventoryPaginationButtons(currentInventoryPage, totalPages);
        document.getElementById('totalInventoryUsageExpenses').textContent = formatCurrency(grandTotalInventoryUsageExpenses, true);
    }

    function updateInventoryPaginationButtons(currentPage, totalPages) {
        document.getElementById('inventoryPrevBtn').disabled = currentPage <= 1;
        document.getElementById('inventoryNextBtn').disabled = currentPage >= totalPages;
    }

    function changeInventoryPage(delta) {
        const totalPages = Math.ceil(allInventory.length / inventoryPerPage);
        const newPage = currentInventoryPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentInventoryPage = newPage;
            renderInventoryTable();
        }
    }

    function openUsage(id) {
        const item = allInventory.find(i => i.id === id);
        if (!item) return;
        usageTargetId = id;
        document.getElementById('usageItemName').textContent = item.name;
        document.getElementById('usageModal').classList.remove('hidden');
        document.getElementById('usageQuantity').focus();
    }

    async function saveUsage() {
        const quantityUsed = parseFloat(document.getElementById('usageQuantity').value);
        const notes = document.getElementById('usageNotes').value.trim();

        if (!usageTargetId || isNaN(quantityUsed) || quantityUsed <= 0) {
            showToast("Please enter a valid quantity used.", "error");
            return;
        }

        // Find the item in our local cache to check stock
        const item = allInventory.find(i => i.id === usageTargetId);
        if (!item) {
            showToast("Could not find the item to log usage for.", "error");
            return;
        }

        // NEW VALIDATION: Check if usage exceeds available stock
        if (quantityUsed > item.currentStock) {
            showToast(`Usage quantity cannot exceed available stock (${item.currentStock} ${item.unit}).`, "error");
            return;
        }

        try {
            const itemRef = getInventoryCollectionRef().doc(usageTargetId);
            // Use a transaction to ensure atomicity
            await db.runTransaction(async (transaction) => {
                const itemDoc = await transaction.get(itemRef);
                if (!itemDoc.exists) throw "Item not found!";
                const currentStock = itemDoc.data().currentStock;
                // Double-check stock inside the transaction to prevent race conditions
                if (quantityUsed > currentStock) {
                    throw new Error(`Usage quantity (${quantityUsed}) exceeds available stock (${currentStock}).`);
                }
                const newStock = currentStock - quantityUsed;
                transaction.update(itemRef, { currentStock: newStock });
                // NEW: Create an expense record for the usage
                const usageExpenseAmount = quantityUsed * itemDoc.data().costPerUnit;
                const expenseData = {
                    expenseDate: new Date().toISOString().split('T')[0], // Current date
                    description: `Inventory Usage: ${itemDoc.data().name} (${quantityUsed} ${itemDoc.data().unit})`,
                    category: "Inventory Usage",
                    amount: usageExpenseAmount,
                    inventoryItemId: usageTargetId, // Link to the inventory item
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                transaction.set(getExpensesCollectionRef().doc(), expenseData);
                const usageLogRef = getInventoryUsageCollectionRef().doc();
                transaction.set(usageLogRef, {
                    itemId: usageTargetId,
                    itemName: itemDoc.data().name,
                    quantityUsed,
                    unit: itemDoc.data().unit, // Store the unit directly
                    costPerUnit: itemDoc.data().costPerUnit, // Store cost per unit
                    expenseAmount: usageExpenseAmount, // Store the calculated expense amount
                    notes,
                    usedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            showToast("Item usage logged successfully!", "success");
            closeModal('usageModal');
            document.getElementById('usageForm').reset();
        } catch (error) {
            console.error("Error logging usage:", error);
            // Provide a more specific error message if it's a stock issue
            if (error.message.includes("exceeds available stock")) {
                showToast(error.message, "error");
            } else {
                showToast("Failed to log usage. The stock might have changed.", "error");
            }
        }
    }

    function openRestock(id) {
        const item = allInventory.find(i => i.id === id);
        if (!item) return;
        restockTargetId = id;
        document.getElementById('restockItemName').textContent = item.name;
        document.getElementById('restockModal').classList.remove('hidden');
        document.getElementById('restockQuantity').focus();
    }

    async function saveRestock() {
        const quantityToAdd = parseFloat(document.getElementById('restockQuantity').value);
        if (!restockTargetId || isNaN(quantityToAdd) || quantityToAdd <= 0) {
            showToast("Please enter a valid quantity to add.", "error");
            return;
        }

        try {
            const itemRef = getInventoryCollectionRef().doc(restockTargetId);
            await itemRef.update({
                currentStock: firebase.firestore.FieldValue.increment(quantityToAdd),
                lastRestocked: firebase.firestore.FieldValue.serverTimestamp()
            });
            showToast("Stock updated successfully!", "success");
            closeModal('restockModal');
            document.getElementById('restockForm').reset();
        } catch (error) {
            console.error("Error restocking item:", error);
            showToast("Failed to update stock.", "error");
        }
    }

    function openEditInventory(id) {
        const item = allInventory.find(i => i.id === id);
        if (!item) return;

        document.getElementById('editInventoryId').value = id;
        document.getElementById('editInventoryName').value = item.name;
        document.getElementById('editInventoryThreshold').value = item.lowStockThreshold;
        document.getElementById('editInventoryCostPerUnit').value = convertFromNgn(item.costPerUnit).toFixed(2);
        document.getElementById('editInventoryModal').classList.remove('hidden');
    }

    async function saveInventoryEdit() {
        const id = document.getElementById('editInventoryId').value;
        const name = document.getElementById('editInventoryName').value.trim();
        const lowStockThreshold = parseFloat(document.getElementById('editInventoryThreshold').value);
        const costPerUnitDisplay = parseFloat(document.getElementById('editInventoryCostPerUnit').value);

        if (!id || !name || isNaN(lowStockThreshold) || isNaN(costPerUnitDisplay)) {
            showToast("Name, Threshold, and Cost per Unit are required.", "error");
            return;
        }

        // Check for duplicates, excluding the current item
        if (allInventory.some(i => i.id !== id && i.name.toLowerCase() === name.toLowerCase())) {
            showToast(`An item named "${name}" already exists.`, "error");
            return;
        }

        const costPerUnit = convertToNgn(costPerUnitDisplay);

        try {
            await getInventoryCollectionRef().doc(id).update({ name, lowStockThreshold, costPerUnit });
            closeModal('editInventoryModal');
            showToast("Inventory item updated.", "success");
        } catch (error) {
            console.error("Error updating inventory item:", error);
            showToast("Update failed.", "error");
        }
    }

    function updateServicePopularity() {
        const serviceData = {};

        // The description says "in the selected date range", so we must use filteredOrders.
        // applyDateFilter() is responsible for setting filteredOrders. When the page loads, this will be all orders.
        const ordersToProcess = filteredOrders;

        ordersToProcess.forEach(order => {
            if (order.items && Array.isArray(order.items)) {
                order.items.forEach(item => {
                    const name = item.description ? item.description.trim() : 'Unknown Service';
                    if (name) {
                        if (!serviceData[name]) {
                            serviceData[name] = { count: 0, revenue: 0 };
                        }
                        const quantity = Number(item.quantity) || 0;
                        // The price on the item is per-unit
                        const price = Number(item.price) || 0;
                        serviceData[name].count += quantity;
                        serviceData[name].revenue += quantity * price;
                    }
                });
            }
        });

        const sortedServices = Object.entries(serviceData)
            .map(([name, data]) => ({ name, ...data }))
            .sort((a, b) => b.count - a.count) // Sort by count as requested
            .slice(0, 5);

        // Update the list
        const listEl = document.getElementById('servicePopularityList');
        if (listEl) {
            listEl.innerHTML = '';

            if (sortedServices.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-500 py-8">No service data for this period.</div>';
            } else {
                sortedServices.forEach((service, index) => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-4 fade-in';
                    el.style.animationDelay = `${index * 80}ms`;
                    el.innerHTML = `
                        <div class="font-bold text-gray-400 w-4 text-right">${index + 1}.</div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${escapeHtml(service.name)}</div>
                            <div class="text-xs text-gray-500">${service.count.toLocaleString()} times ordered</div>
                        </div>
                        <div class="font-semibold text-gray-900 text-right">${formatCurrency(service.revenue)}</div>
                    `;
                    listEl.appendChild(el);
                });
            }
        }

        // Update the chart
        const chartCtx = document.getElementById('servicePopularityChart')?.getContext('2d');
        if (!chartCtx) return;

        if (chartInstances.service) {
            chartInstances.service.destroy();
        }

        if (sortedServices.length === 0) {
            // If there's no data, we don't create a chart.
            return;
        }

        const chartLabels = sortedServices.map(s => s.name);
        // Chart is based on popularity (count of items ordered)
        const chartData = sortedServices.map(s => s.count);

        chartInstances.service = new Chart(chartCtx, {
            type: 'doughnut',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Times Ordered',
                    data: chartData,
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'], // Original colors
                    hoverBackgroundColor: ['#E55975', '#2F8FD2', '#E5B94D', '#43ACA9', '#8959E5', '#E58F39'], // Darker shades for hover
                    borderWidth: 2,
                    borderColor: '#f5f5f7', // Match body background
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '50%',
                elements: {
                    arc: {
                        hoverOffset: 18
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: '#1d1d1f',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        cornerRadius: 6,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed.toLocaleString() + ' times ordered';
                                }
                                return label;
                            }
                        }
                    }
                },
                layout: { // Add this new block for padding
                    padding: 20
                },
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });
    }

    // 4. STATS LOGIC & CHART UPDATE
    function calculateStats() { // Note: This function is becoming large and could be refactored.
        if (!dataReady) return; // Do not run any calculations until the main data is ready.
        const now = new Date();
        const todayStr = now.toDateString();
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toDateString();

        // Comparison Variables
        let todayRevenue = 0;
        let yesterdayRevenue = 0;
        let monthRevenue = 0;
        let lastMonthRevenue = 0;
        let yearRevenue = 0;
        let lastYearRevenue = 0;
        let todayExpenses = 0;
        let yesterdayExpenses = 0;
        let monthExpenses = 0;
        let lifetimeExpenses = 0;
        let lastMonthExpenses = 0;

        // Calculate Dates for Previous Month/Year
        const currentMonth = now.getMonth(); // 0-11
        const currentYear = now.getFullYear();
        const prevMonthIndex = currentMonth === 0 ? 11 : currentMonth - 1;
        const prevMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
        const prevYear = currentYear - 1;

        // Data Arrays for Sparkline Charts
        const todayHourlyData = new Array(24).fill(0);
        const monthDailyData = [];
        const yearMonthlyData = new Array(12).fill(0);

        // Customer Tracking
        const customerFirstSeen = new Map();

        // Setup Month Array size
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        for(let i=0; i<daysInMonth; i++) monthDailyData.push(0);


        // --- Weekly Bar Chart Setup (Current Week: Mon - Sun) ---
        const fixedWeekLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const currentWeekRevenue = new Array(7).fill(0);

        const currentWeekExpenses = new Array(7).fill(0);

        // Determine the start of the current week (Monday at 00:00:00)
        const dayOffset = (now.getDay() + 6) % 7; // 0 for Monday, 6 for Sunday
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - dayOffset);
        weekStart.setHours(0, 0, 0, 0);

        // Determine the end of the current week (Sunday at 23:59:59)
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        weekEnd.setHours(23, 59, 59, 999);

        // The index of the bar corresponding to TODAY
        const currentDayIndex = (now.getDay() + 6) % 7;


        // Yearly Bar Chart Data Structure (Year -> Revenue)
        const yearlyBarData = {};
        const yearMonthlyExpenses = new Array(12).fill(0);

        allExpenses.forEach(expense => {
            if (!expense || !expense.expenseDate || typeof expense.amount !== 'number') return;

            const expenseDate = new Date(expense.expenseDate);
            if (isNaN(expenseDate.getTime())) return; // Skip if date is invalid
            const adjustedExpenseDate = new Date(expenseDate.getTime() + expenseDate.getTimezoneOffset() * 60000);

            if (adjustedExpenseDate.toDateString() === todayStr) {
                todayExpenses += expense.amount;
            }
            if (adjustedExpenseDate.toDateString() === yesterdayStr) {
                yesterdayExpenses += expense.amount;
            }
            if (adjustedExpenseDate.getFullYear() === currentYear && adjustedExpenseDate.getMonth() === currentMonth) {
                monthExpenses += expense.amount;
            }
            if (adjustedExpenseDate.getFullYear() === prevMonthYear && adjustedExpenseDate.getMonth() === prevMonthIndex) {
                lastMonthExpenses += expense.amount;
            }
            lifetimeExpenses += expense.amount;

            // Weekly Expenses Bar Chart
            if (adjustedExpenseDate >= weekStart && adjustedExpenseDate <= weekEnd) {
                const dayIndex = (adjustedExpenseDate.getDay() + 6) % 7; // 0=Mon, 6=Sun
                currentWeekExpenses[dayIndex] += expense.amount;
            }
            // Yearly Expenses (by month) Bar Chart
            if (adjustedExpenseDate.getFullYear() === currentYear) {
                yearMonthlyExpenses[adjustedExpenseDate.getMonth()] += expense.amount;
            }
        });
        
        const todayProfit = todayRevenue - todayExpenses;

        const sortedOrders = [...allOrders].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

        sortedOrders.forEach(order => {
            const orderDate = new Date(order.timestamp);
            const orderDateStr = orderDate.toDateString();
            const amount = parseFloat(order.totalAmount || 0);

            // --- Top Stats & Sparklines ---

            // Daily Stats
            if (orderDateStr === todayStr) {
                todayRevenue += amount;
                todayHourlyData[orderDate.getHours()]++;
            }
            if (orderDateStr === yesterdayStr) {
                yesterdayRevenue += amount;
            }

            // Monthly Logic
            if (orderDate.getFullYear() === currentYear && orderDate.getMonth() === currentMonth) {
                monthRevenue += amount;
                monthDailyData[orderDate.getDate() - 1] += amount;
            }
            // Last Month Logic
            if (orderDate.getFullYear() === prevMonthYear && orderDate.getMonth() === prevMonthIndex) {
                lastMonthRevenue += amount;
            }

            // Yearly Logic
            const orderYear = orderDate.getFullYear();
            if (orderYear === currentYear) {
                yearRevenue += amount;
                yearMonthlyData[orderDate.getMonth()] += amount;
            }
            // Last Year Logic
            if (orderYear === prevYear) {
                lastYearRevenue += amount;
            }

            // --- Weekly Bar Chart Data (Current Week Mon-Sun) ---
            if (orderDate >= weekStart && orderDate <= weekEnd) {
                const dayIndex = (orderDate.getDay() + 6) % 7; // 0=Mon, 6=Sun
                currentWeekRevenue[dayIndex] += amount;
            }

            // --- Yearly Bar Chart Data (Aggregate by Year) ---
            yearlyBarData[orderYear] = (yearlyBarData[orderYear] || 0) + amount;

            // --- Customer First Seen ---
            if (order.customer && order.customer.name) {
                const name = order.customer.name.toLowerCase().trim();
                if (!customerFirstSeen.has(name) || orderDate < customerFirstSeen.get(name)) {
                    customerFirstSeen.set(name, orderDate);
                }
            }
        });

        // Convert yearly map to sorted array
        const sortedYears = Object.keys(yearlyBarData).sort();
        const yearlyBarDataArray = sortedYears.map(year => yearlyBarData[year]);
        const yearlyBarLabels = sortedYears;


        // --- UPDATE BADGES FUNCTION ---
        function updateComparisonBadge(elementId, current, previous, prefix, isCurrency = false) {
            const change = current - previous;
            let percentChange = 0;

            if (previous > 0) {
                percentChange = (change / previous) * 100;
            } else if (current > 0) {
                percentChange = 100;
            }

            const percentStr = `${percentChange >= 0 ? '+' : ''}${Math.round(percentChange)}%`;
            const badge = document.getElementById(elementId);
            const prevValueStr = isCurrency ? formatCurrency(previous) : previous;

            badge.textContent = `vs ${prefix} ${prevValueStr} (${percentStr})`;

            const isPositive = percentChange >= 0;
            badge.className = `text-xs font-medium px-2 py-1 rounded-full inline-block w-fit ${isPositive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
        }

        // 1. Today Badge
        document.getElementById('statTodayRevenueValue').textContent = formatCurrency(todayRevenue, true);
        updateComparisonBadge('statTodayBadge', todayRevenue, yesterdayRevenue, 'yesterday', true, true);

        // 2. Month Badge
        document.getElementById('statMonthRevValue').textContent = formatCurrency(monthRevenue, true);
        updateComparisonBadge('statMonthBadge', monthRevenue, lastMonthRevenue, 'last month', true, true);

        // 3. Year Badge
        document.getElementById('statYearRevValue').textContent = formatCurrency(yearRevenue, true);
        updateComparisonBadge('statYearBadge', yearRevenue, lastYearRevenue, 'last year', true, true);

        // 4. Customers
        document.getElementById('statTotalCustomers').textContent = customerFirstSeen.size;

        // --- Update Expense & Profit Cards ---
        document.getElementById('statTodayProfit').textContent = formatCurrency(todayProfit, true);
        const profitBadge = document.getElementById('statProfitBadge');
        profitBadge.textContent = `${formatCurrency(todayRevenue, true)} - ${formatCurrency(todayExpenses, true)}`;
        profitBadge.className = `text-xs font-medium px-2 py-1 rounded-full w-fit ${todayProfit >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;

        document.getElementById('statTodayExpenses').textContent = formatCurrency(todayExpenses, true);
        document.getElementById('statMonthExpenses').textContent = formatCurrency(monthExpenses, true);
        document.getElementById('statLifetimeExpenses').textContent = formatCurrency(lifetimeExpenses, true);

        // Update Expense Badges with color coding
        const todayExpenseBadge = document.getElementById('statTodayExpensesBadge');
        const monthExpenseBadge = document.getElementById('statMonthExpensesBadge');

        const todayExpenseChange = todayExpenses - yesterdayExpenses;
        todayExpenseBadge.textContent = `vs yesterday ${formatCurrency(yesterdayExpenses, true)}`;
        // For expenses, a positive change (increase) is bad (red), a negative change (decrease) is good (green)
        todayExpenseBadge.className = `text-xs font-medium px-2 py-1 rounded-full w-fit ${todayExpenseChange > 0 ? 'bg-red-100 text-red-700' : todayExpenseChange < 0 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`;

        const monthExpenseChange = monthExpenses - lastMonthExpenses;
        monthExpenseBadge.textContent = `vs last month ${formatCurrency(lastMonthExpenses, true)}`;
        monthExpenseBadge.className = `text-xs font-medium px-2 py-1 rounded-full w-fit ${monthExpenseChange > 0 ? 'bg-red-100 text-red-700' : monthExpenseChange < 0 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`;


        const currentHour = now.getHours();
        const slicedTodayData = todayHourlyData.slice(0, currentHour + 1);
        const todayLabels = slicedTodayData.map((_, i) => {
            const h = i % 12 || 12;
            return `${h}${i < 12 ? 'am' : 'pm'}`;
        });

        // Customers: Cumulative Growth (simplified for yearly view)
        const monthlyNewCustomers = new Array(12).fill(0);
        customerFirstSeen.forEach(date => {
            if (date.getFullYear() === now.getFullYear()) {
                monthlyNewCustomers[date.getMonth()]++;
            }
        });
        let runningTotal = 0;
        const cumulativeCustomers = monthlyNewCustomers.map(count => {
            runningTotal += count;
            return runningTotal;
        });

        // --- Render Sparklines (Chart.js) ---
        updateChart('chartToday', slicedTodayData, todayLabels, 'Orders', '#3b82f6');
        updateChart('chartMonth', monthDailyData, monthDailyData.map((_,i)=>i+1), 'Revenue', '#22c55e');
        updateChart('chartYear', yearMonthlyData, ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], 'Revenue', '#a855f7');
        updateChart('chartCustomers', cumulativeCustomers, ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], 'Total', '#f97316');

        // --- Render Bar Charts ---
        const weekDates = [];
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(weekStart);
            dayDate.setDate(weekStart.getDate() + i);
            weekDates.push(dayDate);
        }
        renderBarChart('weeklyChart', currentWeekRevenue, fixedWeekLabels, currentDayIndex, weekDates);
        
        const monthLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const monthDates = monthLabels.map((_, i) => new Date(currentYear, i, 1));
        renderBarChart('yearlyChart', yearMonthlyData, monthLabels, now.getMonth(), monthDates);

        renderBarChart('weeklyExpensesChart', currentWeekExpenses, fixedWeekLabels, currentDayIndex, weekDates, true);
        const yearMonthlyLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        renderBarChart('yearlyExpensesChart', yearMonthlyExpenses, yearMonthlyLabels, currentMonth, monthDates, true);

        // Update Chart Totals Text
        const weekTotal = currentWeekRevenue.reduce((a, b) => a + b, 0);
        document.getElementById('weeklyTotalDisplay').textContent = `${formatCurrency(weekTotal, true)} this week`;
        document.getElementById('yearlyTotalDisplay').textContent = `${formatCurrency(yearRevenue, true)} this year`;

        // Update Expense Chart Totals Text
        const weekExpensesTotal = currentWeekExpenses.reduce((a,b)=>a+b,0);
        const yearExpensesTotal = yearMonthlyExpenses.reduce((a,b)=>a+b,0);
        document.getElementById('weeklyExpensesTotalDisplay').textContent = `${formatCurrency(weekExpensesTotal, true)} this week`;
        document.getElementById('yearlyExpensesTotalDisplay').textContent = `${formatCurrency(yearExpensesTotal, true)} this year`;

        updateServicePopularity();
    }

    
    // Helper to update sparkline
    function updateChart(canvasId, dataPoints, labels, label, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');

        if (chartInstances[canvasId]) {
            const chart = chartInstances[canvasId];
            chart.data.labels = labels;
            chart.data.datasets[0].data = dataPoints;
            chart.update(); // Smooth update
        } else {
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, // Dummy labels
                    datasets: [{
                        label: label,
                        data: dataPoints,
                        borderColor: color,
                        borderWidth: 2,
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 64);
                            gradient.addColorStop(0, color + '33');
                            gradient.addColorStop(1, color + '00');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointHitRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: true, mode: 'index', intersect: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, min: 0 }
                    },
                    layout: { padding: 0 },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }
    }

    function renderBarChart(elementId, data, labels, activeIndex, dates = null, isExpense = false) {
        const container = document.getElementById(elementId);
        if (!container) return;

        // Always clear the container for a fresh render
        container.innerHTML = '';

        // Add grid lines first
        container.innerHTML += `<div class="chart-grid-line" style="bottom: 25%;"></div>
                                <div class="chart-grid-line" style="bottom: 50%;"></div>
                                <div class="chart-grid-line" style="bottom: 75%;"></div>`;

        const maxVal = Math.max(...data, 1); // Use 1 as a minimum to avoid division by zero

        // Helper function to format date for tooltip
        function formatDateForTooltip(date) {
            if (!date) return '';
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return `${days[date.getDay()]} - ${date.getDate()} - ${date.getFullYear()}`;
        }

        // Helper function to format date for bottom tooltip (abbreviated)
        function formatDateForBottomTooltip(date) {
            if (!date) return '';
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return `${days[date.getDay()]}-${date.getDate()}-${date.getFullYear()}`;
        }

        // Draw New bars
        data.forEach((val, idx) => {
            const height = Math.min((val / maxVal) * 100, 100); // Cap height at 100%
            const wrapper = document.createElement('div');
            wrapper.className = 'bar-wrapper';

            const bar = document.createElement('div');
            const isActive = idx === activeIndex;
            bar.className = `bar ${isActive && !isExpense ? 'active' : ''}`;

            if (isExpense) {
                bar.style.backgroundColor = isActive ? '#dc2626' : '#fca5a5'; // red-600 and red-300
            }

            // Use a minimum height of 0.5% for visibility, but rely on CSS min-height for the actual pixel value
            bar.style.height = `${Math.max(height, 0.5)}%`;

            const formattedVal = formatCurrency(val, true);
            const date = dates && dates[idx] ? dates[idx] : null;

            // Create hover tooltip that shows only the price (top)
            const hoverTooltip = document.createElement('div');
            hoverTooltip.className = 'bar-hover-tooltip';
            hoverTooltip.textContent = formattedVal;

            // Create bottom tooltip that shows date and price
            const bottomTooltip = document.createElement('div');
            bottomTooltip.className = 'bar-bottom-tooltip';
            if (date) {
                bottomTooltip.textContent = `${formatDateForBottomTooltip(date)} | ${formattedVal}`;
            } else {
                bottomTooltip.textContent = formattedVal;
            }

            const label = document.createElement('span');
            label.className = 'bar-label';
            label.textContent = labels[idx];

            wrapper.appendChild(bar);
            wrapper.appendChild(hoverTooltip);
            wrapper.appendChild(bottomTooltip);
            wrapper.appendChild(label);
            container.appendChild(wrapper);
        });
    }

    // 5. FORM & ITEM LOGIC
    function addItemRow(containerId) {
        const container = document.getElementById(containerId);
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 gap-2 items-center fade-in bg-gray-50 p-2 rounded'; // The price here is always in NGN

        let serviceOptions = '<option value="" data-price="0">Select a service...</option>'; 
        allServices.sort((a, b) => a.name.localeCompare(b.name)).forEach(service => {
            serviceOptions += `<option value="${escapeHtml(service.name)}" data-price="${service.price}">${escapeHtml(service.name)} - ${formatCurrency(service.price, true)}</option>`;
        });

        row.innerHTML = `
            <div class="col-span-5">
                <select class="item-desc w-full border-b bg-transparent text-sm focus:outline-none focus:border-blue-500 py-1" onchange="onServiceSelect(this)" required>${serviceOptions}</select>
            </div>
            <div class="col-span-2">
                <input type="number" placeholder="Qty" value="1" min="1" class="item-qty w-full border-b bg-transparent text-sm focus:outline-none py-1 text-center" oninput="calculateRowTotal(this, false)">
            </div>
            <div class="col-span-3">
                <input type="number" placeholder="Price" class="item-price w-full border-b bg-transparent text-sm focus:outline-none py-1" step="0.01" oninput="calculateRowTotal(this, false)">
            </div>
            <div class="col-span-2 flex items-center justify-between">
                <span class="item-row-total text-xs font-semibold text-gray-700">${formatCurrency(0, false)}</span>
                <button type="button" onclick="this.parentElement.parentElement.remove(); calculateGrandTotal('${containerId}', false);" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
            </div>
        `;
        container.appendChild(row);
    }

    function onServiceSelect(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const price = selectedOption.getAttribute('data-price');
        const row = selectElement.closest('.grid');
        const priceInput = row.querySelector('.item-price'); // This input should hold the converted price
        const priceInNgn = parseFloat(price) || 0;
        priceInput.value = convertFromNgn(priceInNgn).toFixed(2);
        calculateRowTotal(priceInput, false); // Recalculate totals for the row and grand total
    }

    function calculateRowTotal(input, isBaseAmountInNgn = true) {
        const row = input.closest('.grid');
        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const total = qty * price;
        row.querySelector('.item-row-total').textContent = formatCurrency(total, isBaseAmountInNgn);

        // Check which form/modal we are in to calculate the correct grand total
        const containerId = row.closest('#itemContainer') ? 'itemContainer' : 'editItemContainer';
        calculateGrandTotal(containerId, false);
    }

    function calculateGrandTotal(containerId = 'itemContainer', isBaseAmountInNgn = true) {
        const displayId = containerId === 'editItemContainer' ? 'editTotalDisplay' : 'formTotalDisplay';
        const rows = document.getElementById(containerId).querySelectorAll('.grid'); // Updated selector
        let total = 0;
        rows.forEach(row => {
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const rowTotal = qty * price;
            total += rowTotal;
        });

        const displayEl = document.getElementById(displayId);
        if(displayEl) displayEl.textContent = formatCurrency(total, isBaseAmountInNgn);
        return total;
    }

    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        try {
            const expenseDate = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDesc').value.trim();
            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);

            if (!expenseDate || !description || !amount) {
                throw new Error("Date, description, and amount are required.");
            }
            if (amount <= 0) throw new Error("Amount must be positive.");

            const expenseData = {
                expenseDate,
                description,
                category,
                amount,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const newDoc = await getExpensesCollectionRef().add(expenseData);
            allExpenses.unshift({ id: newDoc.id, ...expenseData }); // Optimistic update
            renderExpenseTable();
            calculateStats();
            showToast("Expense saved!", "success");
            e.target.reset();
            document.getElementById('expenseDate').valueAsDate = new Date(); // Reset date to today

        } catch (err) {
            showToast(err.message, "error");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Expense';
        }
    });

    function renderExpenseTable() {
        const tbody = document.getElementById('expenseTableBody');
        if (!tbody) return;
        tbody.innerHTML = '';

        // Sorting logic
        const sortKey = sortState.expenses.column;
        const sortDir = sortState.expenses.direction === 'asc' ? 1 : -1;
        const sortedData = [...allExpenses].sort((a, b) => {
            const valA = sortKey === 'date' ? new Date(a.expenseDate) : (typeof a[sortKey] === 'string' ? a[sortKey].toLowerCase() : a[sortKey]);
            const valB = sortKey === 'date' ? new Date(b.expenseDate) : (typeof b[sortKey] === 'string' ? b[sortKey].toLowerCase() : b[sortKey]);
            if (valA < valB) return -1 * sortDir;
            if (valA > valB) return 1 * sortDir;
            return 0;
        });

        const totalPages = Math.ceil(allExpenses.length / expensesPerPage);
        const start = (currentExpensePage - 1) * expensesPerPage;
        const end = start + expensesPerPage;
        const pageData = sortedData.slice(start, end);

        // Update sort indicators
        updateSortIndicators('expenses', 'expenseTableHeaders');
        
        if (pageData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-6 text-center text-gray-500">No expenses logged yet.</td></tr>`;
            document.getElementById('expensePaginationInfo').textContent = 'Showing 0 of 0';
            document.getElementById('expensePageNumbers').textContent = 'Page 0 of 0';
            updateExpensePaginationButtons(0, 0);
            return;
        }

        pageData.forEach(expense => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 transition';
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-gray-600">${formatDate(expense.expenseDate)}</td>
                <td class="px-6 py-4 font-medium text-gray-800">${escapeHtml(expense.description)}</td>
                <td class="px-6 py-4 text-gray-500">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        ${escapeHtml(expense.category)}
                    </span>
                </td>
                <td class="px-6 py-4 font-semibold text-red-600 text-right">-${formatCurrency(expense.amount, true)}</td>
                <td class="px-6 py-4 text-right">
                    <button onclick='openEditExpense("${expense.id}")' class="p-2 text-sm text-orange-500 hover:bg-orange-50 rounded transition" title="Edit"><i class="fas fa-edit"></i></button>
                    <button onclick='openDelete("${expense.id}", "expense")' class="p-2 text-sm text-red-500 hover:bg-red-50 rounded transition" title="Delete"><i class="fas fa-trash-alt"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('expensePaginationInfo').textContent = `Showing ${start + 1} to ${Math.min(end, allExpenses.length)} of ${allExpenses.length}`;
        document.getElementById('expensePageNumbers').textContent = `Page ${currentExpensePage} of ${totalPages}`;
        updateExpensePaginationButtons(currentExpensePage, totalPages);
    }

    function updateExpensePaginationButtons(currentPage, totalPages) {
        const prevBtn = document.getElementById('expensePrevBtn');
        const nextBtn = document.getElementById('expenseNextBtn');

        if (prevBtn && nextBtn) {
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }
    }

    function changeExpensePage(delta) {
        const totalPages = Math.ceil(allExpenses.length / expensesPerPage);
        const newPage = currentExpensePage + delta;

        if (newPage >= 1 && newPage <= totalPages) {
            currentExpensePage = newPage;
            renderExpenseTable();
        }
    }

    document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if(!currentUser || !dataReady) {
            showToast("Still syncing. Please wait a moment.", "error");
            return;
        }

        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.textContent = "Saving...";
        submitBtn.disabled = true;
        submitBtn.dataset.busy = "true";

        try {
            // Gather Data
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            const address = document.getElementById('custAddr').value.trim();

            if (!name) throw new Error("Customer name is required.");
            const phoneDigits = phone.replace(/\D/g, '');
            if (phoneDigits.length < 7) throw new Error("Enter a valid phone number.");
            if (address.length < 5) throw new Error("Address looks too short.");

            const items = [];
            const itemRows = document.getElementById('itemContainer').querySelectorAll('.grid');
            let grandTotal = 0;

            itemRows.forEach(row => {
                const desc = row.querySelector('.item-desc').value;
                const qty = parseFloat(row.querySelector('.item-qty').value);
                const priceInDisplayCurrency = parseFloat(row.querySelector('.item-price').value);
                if(desc && qty > 0 && priceInDisplayCurrency > 0) {
                    const price = convertToNgn(priceInDisplayCurrency); // Convert back to NGN for saving
                    const total = qty * price;
                    items.push({ description: desc, quantity: qty, price: price, total: total });
                    grandTotal += total;
                }
            });

            if(items.length === 0) throw new Error("Add at least one item");

            let manualDate = null;
            if (entryMode === 'old') {
                const manualValue = document.getElementById('manualTimestamp').value;
                if (!manualValue) throw new Error("Select the original date/time for this order.");
                manualDate = new Date(manualValue);
                if (isNaN(manualDate.getTime())) throw new Error("Invalid date selected.");
                if (manualDate.getTime() > Date.now()) throw new Error("Date cannot be in the future.");
            }

            const orderTimestamp = manualDate ? manualDate.toISOString() : new Date().toISOString();

            const orderData = {
                customer: {
                    name,
                    phone,
                    address
                },
                items: items,
                totalAmount: grandTotal,
                status: "pending",
                timestamp: orderTimestamp,
                createdAt: manualDate ? firebase.firestore.Timestamp.fromDate(manualDate) : firebase.firestore.FieldValue.serverTimestamp()
            };

            const newDoc = await getOrdersCollectionRef().add(orderData);
            // Optimistically add to local array to force immediate refresh
            allOrders.unshift({ id: newDoc.id, ...orderData });
            applyDateFilter(); // This will filter and render the table
            calculateStats();
            updateCustomerTable();

            showToast("Order Saved Successfully", "success");
            resetMainForm();

        } catch (err) {
            console.error("[Save Order]", err);
            showToast(err.message, "error");
        } finally {
            submitBtn.textContent = "Save Order";
            submitBtn.disabled = false;
            delete submitBtn.dataset.busy;
        }
    });

    function resetMainForm() {
        document.getElementById('orderForm').reset();
        document.getElementById('itemContainer').innerHTML = ''; 
        // The first row is now added by onDataReady() or when the user clicks "+ Add Item"
        addItemRow('itemContainer');
        document.getElementById('formTotalDisplay').textContent = formatCurrency(0, true);
        if (entryMode === 'old') {
            setEntryMode('new');
        }
        const manualInput = document.getElementById('manualTimestamp');
        if (manualInput) manualInput.value = '';
    }

    // 6. FILTER & TABLE LOGIC
    function updateDateFilterUI(activeType) {
        document.querySelectorAll('.date-filter button').forEach(btn => {
            btn.classList.remove('bg-white', 'shadow-sm', 'text-gray-900');
            btn.classList.add('text-gray-600');
            if (btn.textContent.toLowerCase().includes(activeType.toLowerCase())) {
                btn.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                btn.classList.remove('text-gray-600');
            }
        });
    }


    function setDateFilter(type) {
        const end = new Date();
        const start = new Date();

        if (type === 'today') {
            // start is already today
        } else if (type === 'week') {
            start.setDate(end.getDate() - 7);
        } else if (type === 'month') {
            start.setDate(1); // 1st of current month
        } else if (type === 'all') {
            // Set very old date
            start.setFullYear(2000);
        }

        document.getElementById('filterEnd').valueAsDate = end;
        document.getElementById('filterStart').valueAsDate = start;

        applyDateFilter();
        updateDateFilterUI(type);
    }

    function setStatusFilter(status) {
        currentStatusFilter = status;
        document.querySelectorAll('.status-filter-btn').forEach(btn => {
            const val = btn.getAttribute('data-status');
            if (val === status) {
                btn.classList.remove('border-gray-200', 'text-gray-600', 'bg-white');
                btn.classList.add('bg-gray-900', 'text-white', 'border-gray-900');
            } else {
                btn.classList.add('border-gray-200', 'text-gray-600', 'bg-white');
                btn.classList.remove('bg-gray-900', 'text-white', 'border-gray-900');
            }
        });
        currentPage = 1;
        handleSearch();
    }

    function applyDateFilter() {
        const startVal = document.getElementById('filterStart').value;
        const endVal = document.getElementById('filterEnd').value;

        if (!startVal || !endVal) return;

        // Use ISO strings for reliable comparison with Firestore data if needed
        const startDate = new Date(startVal);
        startDate.setHours(0,0,0,0);

        const endDate = new Date(endVal);
        endDate.setHours(23,59,59,999);

        filteredOrders = allOrders.filter(order => {
            const d = new Date(order.timestamp);
            return d >= startDate && d <= endDate;
        });

        // Update Range Stats
        const totalOrders = filteredOrders.length;
        const totalIncome = filteredOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
        document.getElementById('rangeOrders').textContent = totalOrders;
        document.getElementById('rangeIncome').textContent = formatCurrency(totalIncome, true);

        // Reset search and pagination
        handleSearch(); // This calls renderTable
    }

    function passesStatusFilter(order) {
        if (!currentStatusFilter || currentStatusFilter === 'all') return true;
        const meta = getStatusMeta(order.status);
        return meta.value === currentStatusFilter;
    }

    function getFilteredSearchResults() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const searchResults = filteredOrders.filter(order => {
            if (!passesStatusFilter(order)) return false;
            const name = order.customer?.name?.toLowerCase() || '';
            const dateStr = formatDate(order.timestamp).toLowerCase();
            const total = (order.totalAmount || 0).toString();
            return name.includes(query) || dateStr.includes(query) || total.includes(query);
        });

        // Sorting logic
        const sortKey = sortState.orders.column;
        const sortDir = sortState.orders.direction === 'asc' ? 1 : -1;

        return searchResults.sort((a, b) => {
            let valA, valB;
            if (sortKey === 'date') { valA = new Date(a.timestamp); valB = new Date(b.timestamp); }
            else if (sortKey === 'customer') { valA = a.customer.name.toLowerCase(); valB = b.customer.name.toLowerCase(); }
            else if (sortKey === 'total') { valA = a.totalAmount; valB = b.totalAmount; }

            if (valA < valB) return -1 * sortDir;
            if (valA > valB) return 1 * sortDir;
            return 0;
        });
    }

    function handleSearch() {
        const searchResults = getFilteredSearchResults();
        currentPage = 1;
        renderTable(searchResults);
    }

    function getStatusMeta(statusRaw) {
        const status = (statusRaw || 'pending').toLowerCase();
        switch (status) {
            case 'in_progress':
            case 'in progress':
                return { label: 'In Progress', value: 'in_progress', classes: 'bg-blue-50 text-blue-700 border border-blue-100' };
            case 'ready':
                return { label: 'Ready', value: 'ready', classes: 'bg-amber-50 text-amber-700 border border-amber-100' };
            case 'delivered':
                return { label: 'Delivered', value: 'delivered', classes: 'bg-emerald-50 text-emerald-700 border border-emerald-100' };
            default:
                return { label: 'Pending', value: 'pending', classes: 'bg-gray-100 text-gray-700 border border-gray-200' };
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('recordsTableBody');
        tbody.innerHTML = '';

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = data.slice(start, end);

        // Update sort indicators
        updateSortIndicators('orders', 'recordsTableHeaders');

        if (pageData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No records found</td></tr>`;
            document.getElementById('paginationInfo').textContent = 'Showing 0 of 0';
            return;
        }

        pageData.forEach(order => {
            const itemsCount = order.items ? order.items.length : 0;
            const itemsSummary = itemsCount > 0 ? `${order.items[0].description} ${itemsCount > 1 ? `+${itemsCount-1} more` : ''}` : 'No items';
            const statusMeta = getStatusMeta(order.status);

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 transition border-b border-gray-100 last:border-0';
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-gray-600">${formatDate(order.timestamp)}</td>
                <td class="px-6 py-4 font-medium text-gray-900">
                    <div class="flex flex-col gap-1">
                        <span>${order.customer?.name || '-'}</span>
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium ${statusMeta.classes}">
                            ${statusMeta.label}
                        </span>
                    </div>
                </td>
                <td class="px-6 py-4 text-gray-500">${itemsSummary}</td>
                <td class="px-6 py-4 font-semibold text-gray-900">${formatCurrency(order.totalAmount, true)}</td>
                <td class="px-6 py-4 text-right space-y-1">
                    <div class="flex justify-end gap-1 mb-1">
                        <button onclick='openView("${order.id}")' class="p-2 text-blue-500 hover:bg-blue-50 rounded transition" title="View"><i class="fas fa-eye"></i></button>
                        <button onclick='openEdit("${order.id}")' class="p-2 text-orange-500 hover:bg-orange-50 rounded transition" title="Edit"><i class="fas fa-edit"></i></button>
                        <button onclick='openDelete("${order.id}")' class="p-2 text-red-500 hover:bg-red-50 rounded transition" title="Delete"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="flex justify-end">
                        <select class="text-xs border border-gray-200 rounded px-2 py-1 bg-white text-gray-700 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                onchange='handleStatusChange("${order.id}", this.value)'>
                            <option value="pending" ${statusMeta.value === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="in_progress" ${statusMeta.value === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="ready" ${statusMeta.value === 'ready' ? 'selected' : ''}>Ready</option>
                            <option value="delivered" ${statusMeta.value === 'delivered' ? 'selected' : ''}>Delivered</option>
                        </select>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('paginationInfo').textContent = `Showing ${start + 1} to ${Math.min(end, data.length)} of ${data.length}`;
    }

    function changePage(delta) {
        const currentList = getFilteredSearchResults();

        const maxPage = Math.ceil(currentList.length / rowsPerPage);
        const newPage = currentPage + delta;

        if (newPage >= 1 && newPage <= maxPage) {
            currentPage = newPage;
            renderTable(currentList);
        }
    }

    // 7. MODAL ACTIONS
    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
    }

    function getOrder(id) {
        return allOrders.find(o => o.id === id);
    }

    async function updateOrderStatus(id, newStatus) {
        const order = getOrder(id);
        if (!order || !newStatus) return;

        const normalised = getStatusMeta(newStatus).value;

        try {
            await getOrdersCollectionRef().doc(id).update({ status: normalised });

            // Update local copies
            const applyLocal = (list) => {
                const idx = list.findIndex(o => o.id === id);
                if (idx !== -1) list[idx].status = normalised;
            };
            applyLocal(allOrders);
            applyLocal(filteredOrders);

            handleSearch(); // re-render with filters/search
            showToast(`Status updated to ${getStatusMeta(normalised).label}`, "success");
        } catch (err) {
            console.error("[Update Status]", err);
            showToast("Failed to update status", "error");
        }

        // --- NEW: Send SMS if status is 'ready' ---
        if (normalised === 'ready') {
            try {
                const sendSms = functions.httpsCallable('sendSmsNotification');
                await sendSms({
                    customerName: order.customer.name,
                    customerPhone: order.customer.phone,
                    orderTotal: formatCurrency(order.totalAmount)
                });
                showToast("Pickup notification SMS sent!", "info");
            } catch (error) {
                console.error("SMS Function Call Failed:", error);
                showToast("Failed to send SMS.", "error");
            }
        }
    }

    function handleStatusChange(id, value) {
        updateOrderStatus(id, value);
    }

    // View Action
    function openView(id) {
        const order = getOrder(id);
        if(!order) return;
        document.getElementById('viewTotal').textContent = formatCurrency(order.totalAmount, true);
        document.getElementById('viewDate').textContent = formatDate(order.timestamp);
        document.getElementById('viewName').textContent = order.customer.name;
        document.getElementById('viewPhone').textContent = order.customer.phone;
        document.getElementById('viewAddress').textContent = order.customer.address;

        const list = document.getElementById('viewItemsList');
        list.innerHTML = '';
        order.items.forEach(item => {
            const div = document.createElement('div');
            div.className = "flex justify-between border-b border-gray-200 py-2 last:border-0";
            div.innerHTML = `
                <span>${item.description} <span class="text-xs text-gray-500">x${item.quantity}</span></span>
                <span class="font-medium">${formatCurrency(item.price * item.quantity, true)}</span>
            `;
            list.appendChild(div);
        });

        document.getElementById('viewModal').classList.remove('hidden');
    }

    // Edit Action
    function openEdit(id) {
        const order = getOrder(id);
        if(!order) return;

        document.getElementById('editOrderId').value = id;
        document.getElementById('editName').value = order.customer.name;
        document.getElementById('editPhone').value = order.customer.phone;
        document.getElementById('editAddress').value = order.customer.address;

        const container = document.getElementById('editItemContainer');
        container.innerHTML = '';

        // Recreate rows
        order.items.sort((a, b) => a.description.localeCompare(b.description)).forEach(item => {
            const row = document.createElement('div');
            
            let serviceOptions = '<option value="" data-price="0">Select a service...</option>';
            allServices.forEach(service => {
                const isSelected = service.name === item.description ? 'selected' : '';
                serviceOptions += `<option value="${escapeHtml(service.name)}" data-price="${service.price}" ${isSelected}>${escapeHtml(service.name)} - ${formatCurrency(service.price, true)}</option>`; // Price is in NGN
            });

            row.className = 'grid grid-cols-12 gap-2 items-center bg-gray-50 p-2 rounded mb-2';
            row.innerHTML = `
                <div class="col-span-5">
                    <select class="item-desc w-full border-b bg-transparent text-sm" onchange="onServiceSelect(this)" required>${serviceOptions}</select>
                </div>
                <div class="col-span-2">
                    <input type="number" value="${item.quantity}" class="item-qty w-full border-b bg-transparent text-sm text-center" oninput="calculateRowTotal(this, false)">
                </div>
                <div class="col-span-3">
                    <input type="number" value="${convertFromNgn(item.price).toFixed(2)}" class="item-price w-full border-b bg-transparent text-sm" step="0.01" oninput="calculateRowTotal(this, false)">
                </div>
                <div class="col-span-2 flex items-center justify-between">
                    <span class="item-row-total text-xs font-semibold text-gray-700">${formatCurrency(item.total || 0, true)}</span>
                    <button type="button" onclick="this.parentElement.parentElement.remove(); calculateGrandTotal('editItemContainer', false);" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                </div>
            `;
            container.appendChild(row);
        });

        calculateGrandTotal('editItemContainer', false);
        document.getElementById('editModal').classList.remove('hidden');
    }

    async function saveEdit() {
        const id = document.getElementById('editOrderId').value;
        const name = document.getElementById('editName').value;
        const phone = document.getElementById('editPhone').value;

        // Validation Logic
        if (!name.trim() || !phone.trim()) {
            showToast("Name and Phone are required.", "error");
            return;
        }

        // Gather Data similar to create
        const items = [];
        const itemRows = document.getElementById('editItemContainer').querySelectorAll('.grid');
        let grandTotal = 0;

        // Prices in the edit form are already in the display currency, so they need to be converted back to NGN for saving.
        itemRows.forEach(row => {
            const desc = row.querySelector('.item-desc').value;
            const qty = parseFloat(row.querySelector('.item-qty').value);
            const priceInDisplayCurrency = parseFloat(row.querySelector('.item-price').value);

            if(desc && qty && priceInDisplayCurrency) {
                const price = convertToNgn(priceInDisplayCurrency); // Convert back to NGN
                const total = qty*price;
                items.push({ description: desc, quantity: qty, price: price, total: total });
                grandTotal += total;
            }
        });

        if(items.length === 0) {
            showToast("Order must have at least one item.", "error");
            return;
        }

        const updatedData = {
            'customer.name': name,
            'customer.phone': phone,
            'customer.address': document.getElementById('editAddress').value,
            items: items,
            totalAmount: grandTotal
        };

        try {
            await getOrdersCollectionRef().doc(id).update(updatedData);
            
            // Optimistic update
            const orderIndex = allOrders.findIndex(o => o.id === id);
            if (orderIndex > -1) {
                allOrders[orderIndex] = { ...allOrders[orderIndex], ...updatedData };
            }
            applyDateFilter();
            calculateStats();
            updateCustomerTable();

            closeModal('editModal');
            showToast("Order Updated", "success");
        } catch (err) {
            console.error("[Update Order]", err);
            showToast("Failed to update order", "error");
        }
    }

    // Delete Action
    function openDelete(id, type = 'order') {
        deleteTargetId = id;
        deleteTargetType = type;
        const modalText = document.querySelector('#deleteModal p');
        const modalTitle = document.querySelector('#deleteModal h3');        

        switch (type) { // Added 'inventory' case
            case 'expense':
                modalTitle.textContent = 'Delete Expense?';
                modalText.textContent = 'Are you sure you want to delete this expense? This action cannot be undone.';
                break;
            case 'service':
                modalTitle.textContent = 'Delete Service?';
                modalText.textContent = 'Are you sure you want to delete this service? This will not affect past orders.';
                break;
            case 'inventory':
                modalTitle.textContent = 'Delete Inventory Item?';
                modalText.textContent = 'Are you sure you want to delete this item from your inventory?';
                break;
            default: // 'order'
                modalTitle.textContent = 'Delete Record?';
                modalText.textContent = 'Are you sure you want to delete this order? This action cannot be undone.';
        }

        document.getElementById('deleteModal').classList.remove('hidden');
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
        if(!deleteTargetId) return;
        let collectionRef, successMsg;

        switch (deleteTargetType) {
            case 'expense':
                collectionRef = getExpensesCollectionRef();
                successMsg = "Expense Deleted";
                break;
            case 'service':
                collectionRef = getServicesCollectionRef();
                successMsg = "Service Deleted";
                break;
            case 'inventory':
                collectionRef = getInventoryCollectionRef();
                successMsg = "Inventory Item Deleted";
                break;
            default: // 'order'
                collectionRef = getOrdersCollectionRef();
                successMsg = "Record Deleted";
        }
        try {
            await collectionRef.doc(deleteTargetId).delete();

            // Manually update local state for immediate UI response
            if (deleteTargetType === 'order') {
                allOrders = allOrders.filter(o => o.id !== deleteTargetId);
                applyDateFilter();
                calculateStats();
                updateCustomerTable();
            } else if (deleteTargetType === 'expense') {
                allExpenses = allExpenses.filter(e => e.id !== deleteTargetId);
                renderExpenseTable();
                calculateStats();
            } else if (deleteTargetType === 'service') {
                allServices = allServices.filter(s => s.id !== deleteTargetId);
                renderServicesTable();
                updateAllServiceDropdowns();
                calculateStats();
            } else if (deleteTargetType === 'inventory') {
                allInventory = allInventory.filter(i => i.id !== deleteTargetId);
                renderInventoryTable();
                updateLowStockList();
            }

            closeModal('deleteModal');
            showToast(successMsg, "success");
        } catch (err) {
            console.error("[Delete]", err);
            showToast("Delete Failed", "error");
        }
    });

    function setFormInteractive(isEnabled) {
        const submitBtn = document.querySelector('#orderForm button[type="submit"]');
        const notice = document.getElementById('formSyncNotice');

        if (submitBtn && !submitBtn.dataset.busy) {
            submitBtn.textContent = isEnabled ? "Save Order" : "Syncing...";
            submitBtn.disabled = !isEnabled;
        } else if (submitBtn && submitBtn.dataset.busy) {
            submitBtn.disabled = true;
        }

        if (notice) notice.classList.toggle('hidden', isEnabled);
    }

    function setLoadingState(isLoading) {
        const loader = document.getElementById('initialLoader');
        if (!loader) return;
        if (isLoading) loader.classList.remove('hidden');
        else loader.classList.add('hidden');
    }

    function openEditExpense(id) {
        const expense = allExpenses.find(e => e.id === id);
        if (!expense) return;

        document.getElementById('editExpenseId').value = id;
        document.getElementById('editExpenseDate').value = expense.expenseDate;
        document.getElementById('editExpenseDesc').value = expense.description;
        document.getElementById('editExpenseCategory').value = expense.category;
        document.getElementById('editExpenseAmount').value = convertFromNgn(expense.amount).toFixed(2);

        document.getElementById('editExpenseModal').classList.remove('hidden');
    }

    async function saveExpenseEdit() {
        const id = document.getElementById('editExpenseId').value;
        const expenseDate = document.getElementById('editExpenseDate').value;
        const description = document.getElementById('editExpenseDesc').value.trim();
        const category = document.getElementById('editExpenseCategory').value;
        const amount = parseFloat(document.getElementById('editExpenseAmount').value);
        const originalExpense = allExpenses.find(e => e.id === id);

        if (!id || !expenseDate || !description || !amount) {
            showToast("All fields are required.", "error");
            return;
        }

        const amountInNgn = convertToNgn(amount);
        if (amount <= 0) {
            showToast("Amount must be a positive number.", "error");
            return;
        }

        const updatedData = {
            expenseDate,
            description,
            category,
            amount: amountInNgn
        };

        try {
            await getExpensesCollectionRef().doc(id).update(updatedData);
            
            // Optimistic update
            const expenseIndex = allExpenses.findIndex(e => e.id === id);
            if (expenseIndex > -1) {
                allExpenses[expenseIndex] = { ...allExpenses[expenseIndex], ...updatedData };
            }
            renderExpenseTable();
            calculateStats();

            closeModal('editExpenseModal');
            showToast("Expense Updated", "success");
        } catch (err) {
            console.error("[Update Expense]", err);
            showToast("Update Failed", "error");
        }
    }


    function updateLastSyncTime() {
        const el = document.getElementById('backupTime');
        if (!el) return;

        if (allOrders.length > 0) {
            const lastRecordTimestamp = allOrders[0].timestamp;
            const lastRecordDate = new Date(lastRecordTimestamp);
            el.textContent = `Last entry: ${lastRecordDate.toLocaleString([], { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true 
            })}`;
        } else {
            el.textContent = 'No entries yet';
        }
    }

    function initScrollAnimations() {
        const animatedEls = document.querySelectorAll('[data-animate]');
        if (!animatedEls.length) return;

        if (!('IntersectionObserver' in window)) {
            animatedEls.forEach(el => el.classList.add('in-view'));
            return;
        }

        const observer = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('in-view');
                    obs.unobserve(entry.target);
                }
            });
        }, { threshold: 0.15, rootMargin: '0px 0px -5% 0px' });

        animatedEls.forEach(el => observer.observe(el));
    }

    function updateLowStockList() {
        const listEl = document.getElementById('lowStockList');
        if (!listEl) return;

        const lowStockItems = allInventory.filter(item => item.currentStock <= item.lowStockThreshold);

        if (lowStockItems.length === 0) {
            listEl.innerHTML = '<p class="text-sm text-gray-500">All items are well-stocked. 👍</p>';
            return;
        }

        listEl.innerHTML = lowStockItems.map(item => `
            <div class="flex justify-between items-center bg-amber-50 border border-amber-100 rounded-lg px-3 py-2">
                <span class="font-medium text-amber-800">${escapeHtml(item.name)}</span>
                <span class="font-bold text-amber-900">${item.currentStock} / ${item.lowStockThreshold} ${escapeHtml(item.unit)}</span>
            </div>
        `).join('');
    }

    // 8. UTILS
    function convertToNgn(amount) {
        const targetCurrency = appSettings.currencyCode || 'NGN';
        if (targetCurrency === 'NGN' || !amount) return amount;

        const rate = appSettings.exchangeRates?.[targetCurrency];
        if (rate && rate > 0) {
            // To convert from the foreign currency TO NGN, we multiply.
            // e.g., (2 USD) * (1450 NGN/USD) = 2900 NGN.
            return amount * rate;
        }
        return amount; // Fallback if rate is missing
    }

    function convertFromNgn(amountInNgn) {
        const targetCurrency = appSettings.currencyCode || 'NGN';
        if (targetCurrency === 'NGN' || !amountInNgn) return amountInNgn;

        const rate = appSettings.exchangeRates?.[targetCurrency];
        if (rate && rate > 0) {
            // To convert FROM NGN to the foreign currency, we divide.
            // e.g., (2900 NGN) / (1450 NGN/USD) = 2 USD.
            return amountInNgn / rate;
        }
        return amountInNgn; // Return original amount if conversion is not possible
    }

    function formatCurrency(amount, isBaseAmountInNgn = true) {
        const targetCurrency = appSettings.currencyCode || 'NGN';
        let displayAmount = amount || 0;

        // If the amount provided is in the base currency (NGN), convert it for display.
        if (isBaseAmountInNgn) {
            displayAmount = convertFromNgn(amount);
        }
        // If isBaseAmountInNgn is false, it means the amount is already in the target currency.

        // Handle potential conversion errors where rate might be missing
        if (isBaseAmountInNgn && targetCurrency !== 'NGN' && displayAmount === amount && amount !== 0) {
             console.warn(`Exchange rate for ${targetCurrency} is not available. Displaying base amount.`);
        }

        // Format the (potentially converted) amount with the correct currency symbol and style.
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: targetCurrency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(displayAmount);
    }

    function formatDate(isoString) {
        const d = new Date(isoString);
        return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function showToast(msg, type) {
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMsg');
        toastMsg.textContent = msg;        
        toast.className = `fixed top-5 right-5 px-6 py-3 rounded-lg shadow-xl transform transition-transform duration-300 z-[9999] flex items-center gap-3 text-white ${type === 'success' ? 'bg-green-600' : type === 'info' ? 'bg-blue-500' : 'bg-red-600'}`;
        toast.classList.remove('translate-x-full');

        setTimeout(() => {
            toast.classList.add('translate-x-full');
        }, 3000);
    }

    function setEntryMode(mode) {
        entryMode = mode;
        const newBtn = document.getElementById('entryModeNew');
        const oldBtn = document.getElementById('entryModeOld');
        const manualWrapper = document.getElementById('manualDateWrapper');
        const manualInput = document.getElementById('manualTimestamp');

        if (mode === 'old') {
            newBtn.classList.remove('bg-gray-900', 'text-white');
            newBtn.classList.add('text-gray-600');

            oldBtn.classList.add('bg-gray-900', 'text-white');
            oldBtn.classList.remove('text-gray-600');

            manualWrapper.classList.remove('hidden');
        } else {
            oldBtn.classList.remove('bg-gray-900', 'text-white');
            oldBtn.classList.add('text-gray-600');

            newBtn.classList.add('bg-gray-900', 'text-white');
            newBtn.classList.remove('text-gray-600');

            manualWrapper.classList.add('hidden');
            manualInput.value = '';
        }
    }

    function setupEntryModeToggle() {
        const newBtn = document.getElementById('entryModeNew');
        const oldBtn = document.getElementById('entryModeOld');

        if (newBtn && oldBtn) {
            newBtn.addEventListener('click', () => setEntryMode('new'));
            oldBtn.addEventListener('click', () => setEntryMode('old'));
            setEntryMode('new');
        }
    }

    /*******************************
     * 9. CUSTOMER HISTORY FUNCTIONALITY
     *******************************/
    let customerData = [];
    let filteredCustomers = [];
    let currentCustomerPage = 1;
    const customersPerPage = 5;

    // Calculate customer data from all orders
    function calculateCustomerData() {
        const customerMap = new Map();

        allOrders.forEach(order => {
            if (!order.customer || !order.customer.name) return;

            const customerKey = order.customer.name.toLowerCase().trim();
            const customerPhone = order.customer.phone || '';
            const customerAddress = order.customer.address || '';

            if (!customerMap.has(customerKey)) {
                customerMap.set(customerKey, {
                    name: order.customer.name,
                    phone: customerPhone,
                    address: customerAddress,
                    orders: [],
                    totalSpent: 0,
                    totalOrders: 0
                });
            }

            const customer = customerMap.get(customerKey);
            customer.orders.push(order);
            customer.totalSpent += parseFloat(order.totalAmount || 0);
            customer.totalOrders++;

            // Update phone/address if they were missing
            if (!customer.phone && customerPhone) customer.phone = customerPhone;
            if (!customer.address && customerAddress) customer.address = customerAddress;
        });

        customerData = Array.from(customerMap.values()).sort((a, b) => b.totalSpent - a.totalSpent);
        filteredCustomers = [...customerData];
    }

    // Render customer table
    function renderCustomerTable(data = filteredCustomers) {
        const tbody = document.getElementById('customerTableBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        // Sorting logic
        const sortKey = sortState.customers.column;
        const sortDir = sortState.customers.direction === 'asc' ? 1 : -1;
        const sortedData = [...data].sort((a, b) => {
            const valA = sortKey === 'name' ? a.name.toLowerCase() : a[sortKey];
            const valB = sortKey === 'name' ? b.name.toLowerCase() : b[sortKey];
            if (valA < valB) return -1 * sortDir;
            if (valA > valB) return 1 * sortDir;
            return 0;
        });

        // Update sort indicators
        updateSortIndicators('customers', 'customerTableHeaders');

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No customers found</td></tr>`;
            document.getElementById('customerPaginationInfo').textContent = 'Showing 0 of 0';
            document.getElementById('customerPageNumbers').textContent = 'Page 0 of 0';
            updateCustomerPaginationButtons(0, 0);
            return;
        }

        // Calculate pagination based on the sorted data
        const totalPages = Math.ceil(sortedData.length / customersPerPage);
        const start = (currentCustomerPage - 1) * customersPerPage;
        const end = start + customersPerPage;
        const pageData = sortedData.slice(start, end);

        // Render only the current page
        pageData.forEach((customer, index) => {
            // Sort orders by date to get first order
            const sortedOrders = [...customer.orders].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const firstOrder = sortedOrders[0];
            const lastOrder = sortedOrders[sortedOrders.length - 1];

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 transition border-b border-gray-100 last:border-0';
            tr.innerHTML = `
                <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-sm">
                            ${customer.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">${escapeHtml(customer.name)}</div>
                            <div class="text-xs text-gray-500">Last order: ${formatDate(lastOrder.timestamp)}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 text-gray-600">${escapeHtml(customer.phone) || '-'}</td>
                <td class="px-6 py-4 text-center">
                    <span class="inline-flex items-center justify-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">
                        ${customer.totalOrders}
                    </span>
                </td>
                <td class="px-6 py-4 text-right font-semibold text-gray-900">${formatCurrency(customer.totalSpent, true)}</td>
                <td class="px-6 py-4 text-right">
                    <button onclick='openCustomerHistory(${JSON.stringify(customer.name)})' class="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition">
                        <i class="fas fa-history"></i>
                        View History
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Update pagination info
        document.getElementById('customerPaginationInfo').textContent = `Showing ${start + 1} to ${Math.min(end, sortedData.length)} of ${sortedData.length}`;
        document.getElementById('customerPageNumbers').textContent = `Page ${currentCustomerPage} of ${totalPages}`;
        updateCustomerPaginationButtons(currentCustomerPage, totalPages);
    }

    // Update pagination button states
    function updateCustomerPaginationButtons(currentPage, totalPages) {
        const prevBtn = document.getElementById('customerPrevBtn');
        const nextBtn = document.getElementById('customerNextBtn');

        if (prevBtn && nextBtn) {
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }
    }

    // Change customer page
    function changeCustomerPage(delta) {
        const totalPages = Math.ceil(filteredCustomers.length / customersPerPage);
        const newPage = currentCustomerPage + delta;

        if (newPage >= 1 && newPage <= totalPages) {
            currentCustomerPage = newPage;
            renderCustomerTable(filteredCustomers);
        }
    }

    // Handle customer search
    function handleCustomerSearch() {
        const query = document.getElementById('customerSearchInput').value.toLowerCase().trim();

        if (!query) {
            filteredCustomers = [...customerData];
        } else {
            filteredCustomers = customerData.filter(customer => {
                return customer.name.toLowerCase().includes(query) ||
                       customer.phone.toLowerCase().includes(query) ||
                       customer.address.toLowerCase().includes(query);
            });
        }

        // Reset to page 1 when searching
        currentCustomerPage = 1;
        renderCustomerTable(filteredCustomers);
    }

    // Open customer history modal
    async function openCustomerHistory(customerName) {
        const customer = customerData.find(c => c.name === customerName);
        if (!customer) return;

        // Clear old notes and reset save button
        document.getElementById('customerNotesText').value = '';
        const saveBtn = document.getElementById('saveCustomerNotesBtn');

        // Set customer info
        document.getElementById('customerHistoryName').textContent = customer.name; // This is the key
        document.getElementById('customerHistoryPhone').textContent = customer.phone || 'N/A';
        document.getElementById('customerHistoryAddress').textContent = customer.address || 'N/A';

        // Set stats
        document.getElementById('customerTotalOrders').textContent = customer.totalOrders;
        document.getElementById('customerTotalSpent').textContent = formatCurrency(customer.totalSpent, true);

        // Sort orders by date (oldest first)
        const sortedOrders = [...customer.orders].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        const firstOrder = sortedOrders[0];
        document.getElementById('customerFirstOrder').textContent = formatDate(firstOrder.timestamp);

        // Render order list (newest first)
        const ordersList = document.getElementById('customerOrdersList');
        ordersList.innerHTML = '';

        sortedOrders.reverse().forEach((order, index) => {
            const statusMeta = getStatusMeta(order.status);
            const itemsCount = order.items ? order.items.length : 0;

            const orderCard = document.createElement('div');
            orderCard.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition';
            orderCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-semibold text-gray-900">Order #${sortedOrders.length - index}</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium ${statusMeta.classes}">
                                ${statusMeta.label}
                            </span>
                        </div>
                        <div class="text-xs text-gray-500">${formatDate(order.timestamp)}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg text-gray-900">${formatCurrency(order.totalAmount)}</div>
                        <button onclick='openView("${order.id}")' class="text-xs text-blue-600 hover:text-blue-800 font-medium mt-1">
                            View Details →
                        </button>
                    </div>
                </div>
                <div class="border-t border-gray-100 pt-2 mt-2">
                    <div class="text-xs text-gray-600">
                        <span class="font-medium">${itemsCount} item${itemsCount !== 1 ? 's' : ''}</span>: 
                        ${order.items.map(item => `${item.description} (×${item.quantity})`).join(', ')}
                    </div>
                </div>
            `;
            ordersList.appendChild(orderCard);
        });

        // --- NEW: Load and handle notes ---
        try {
            const notesDocRef = getCustomerNotesCollectionRef().doc(customer.name);
            const doc = await notesDocRef.get();
            if (doc.exists) {
                document.getElementById('customerNotesText').value = doc.data().notes || '';
            }
        } catch (error) {
            console.error("Error fetching customer notes:", error);
            showToast("Could not load notes.", "error");
        }

        // Re-assign event listener to avoid issues with closures
        saveBtn.onclick = () => saveCustomerNotes(customer.name);

        // Show modal
        document.getElementById('customerHistoryModal').classList.remove('hidden');
    }

    async function saveCustomerNotes(customerName) {
        const notesText = document.getElementById('customerNotesText').value;
        const saveBtn = document.getElementById('saveCustomerNotesBtn');
        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;

        try {
            await getCustomerNotesCollectionRef().doc(customerName).set({ notes: notesText, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() });
            showToast("Notes saved successfully!", "success");
        } catch (error) {
            console.error("Error saving notes:", error);
            showToast("Failed to save notes.", "error");
        } finally {
            saveBtn.textContent = 'Save Notes';
            saveBtn.disabled = false;
        }
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Update customer table when data changes
    function updateCustomerTable() {
        calculateCustomerData();
        renderCustomerTable();
    }

    /*********************************
     * 10. DEEPER BUSINESS ANALYTICS
     *********************************/

    // Start
    setFormInteractive(false);
    setLoadingState(true);
    setupEntryModeToggle();
    document.getElementById('expenseDate').valueAsDate = new Date();
    initScrollAnimations();
    init();
</script>
<script>
    /*********************************
     * 10. PROFIT & LOSS REPORT
     *********************************/
    let plChartInstance = null;

    function openProfitLossModal() {
        document.getElementById('profitLossModal').classList.remove('hidden');
        // Default to 'This Month' view when opening
        calculateAndDisplayPL('month');
        setupPLDateFilterButtons();
    }

    function setupPLDateFilterButtons() {
        const filterContainer = document.getElementById('plDateFilter');
        filterContainer.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON') {
                const period = e.target.getAttribute('data-period');
                if (period) {
                    // Update active button style
                    filterContainer.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('bg-white', 'shadow-sm', 'text-gray-900');
                        btn.classList.add('text-gray-600');
                    });
                    e.target.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                    e.target.classList.remove('text-gray-600');

                    calculateAndDisplayPL(period);
                }
            }
        });
    }

    function calculateAndDisplayPL(period) {
        const now = new Date();
        let startDate, endDate = new Date();
        let labels, revenueData, expenseData;

        if (period === 'week') {
            const dayOffset = (now.getDay() + 6) % 7; // Monday is 0
            startDate = new Date(now);
            startDate.setDate(now.getDate() - dayOffset);
            startDate.setHours(0, 0, 0, 0);
            labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            revenueData = new Array(7).fill(0);
            expenseData = new Array(7).fill(0);

            allOrders.forEach(o => {
                const d = new Date(o.timestamp);
                if (d >= startDate && d <= endDate) {
                    const dayIndex = (d.getDay() + 6) % 7;
                    revenueData[dayIndex] += o.totalAmount;
                }
            });
            allExpenses.forEach(e => {
                const d = new Date(new Date(e.expenseDate).getTime() + new Date(e.expenseDate).getTimezoneOffset() * 60000);
                if (d >= startDate && d <= endDate) {
                    const dayIndex = (d.getDay() + 6) % 7;
                    expenseData[dayIndex] += e.amount;
                }
            });

        } else if (period === 'year') {
            startDate = new Date(now.getFullYear(), 0, 1);
            labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            revenueData = new Array(12).fill(0);
            expenseData = new Array(12).fill(0);

            allOrders.forEach(o => { if (new Date(o.timestamp).getFullYear() === now.getFullYear()) revenueData[new Date(o.timestamp).getMonth()] += o.totalAmount; });
            allExpenses.forEach(e => { if (new Date(e.expenseDate).getFullYear() === now.getFullYear()) expenseData[new Date(e.expenseDate).getMonth()] += e.amount; });

        } else { // Default to month
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            revenueData = new Array(daysInMonth).fill(0);
            expenseData = new Array(daysInMonth).fill(0);

            allOrders.forEach(o => { const d = new Date(o.timestamp); if (d >= startDate && d <= endDate) revenueData[d.getDate() - 1] += o.totalAmount; });
            allExpenses.forEach(e => { const d = new Date(new Date(e.expenseDate).getTime() + new Date(e.expenseDate).getTimezoneOffset() * 60000); if (d >= startDate && d <= endDate) expenseData[d.getDate() - 1] += e.amount; });
        }

        const totalRevenue = revenueData.reduce((a, b) => a + b, 0);
        const totalExpenses = expenseData.reduce((a, b) => a + b, 0);
        const netProfit = totalRevenue - totalExpenses;

        document.getElementById('plRevenue').textContent = formatCurrency(totalRevenue, true);
        document.getElementById('plExpenses').textContent = formatCurrency(totalExpenses, true);
        document.getElementById('plProfit').textContent = formatCurrency(netProfit, true);

        renderPLChart(labels, revenueData, expenseData);
    }

    function renderPLChart(labels, revenueData, expenseData) {
        const ctx = document.getElementById('plChart').getContext('2d');
        if (plChartInstance) {
            plChartInstance.destroy();
        }
        plChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Revenue',
                    data: revenueData,
                    backgroundColor: 'rgba(34, 197, 94, 0.6)', // green-500
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                }, {
                    label: 'Expenses',
                    data: expenseData,
                    backgroundColor: 'rgba(239, 68, 68, 0.6)', // red-500
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value, false).replace(/\.00$/, '');
                            }
                        }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${formatCurrency(context.raw, true)}`;
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
            }
        });
    }

    function renderDoughnutChart(canvasId, dataPoints, labels, colors) {
        const ctx = document.getElementById(canvasId).getContext('2d');

        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }

        chartInstances[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Revenue',
                    data: dataPoints,
                    backgroundColor: colors,
                    borderColor: '#ffffff',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        display: false // We have a custom list, so we hide the default legend
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return ` ${context.label}: ${formatCurrency(context.raw, true)}`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
<script>
    /*********************************
     * 10. ADVANCED REPORTING & EXPORT
     *********************************/

    function exportFullReport() {
        const revenueData = getFilteredSearchResults();

        if (revenueData.length === 0) {
            showToast("No data to export.", "info");
            return;
        }
        
        // Calculate the total amount for the footer
        const totalRevenueSum = revenueData.reduce((sum, order) => {
            // Ensure we are adding a number
            return sum + (parseFloat(order.totalAmount) || 0);
        }, 0);

        const headers = [
            "Order ID", "Date", "Customer Name", "Customer Phone", "Customer Address",
            "Status", "Total Amount", "Items"
        ];

        // Filter expenses based on the same date range
        const startVal = document.getElementById('filterStart').value;
        const endVal = document.getElementById('filterEnd').value;
        const startDate = new Date(startVal);
        startDate.setHours(0, 0, 0, 0);
        const endDate = new Date(endVal);
        endDate.setHours(23, 59, 59, 999);

        const expenseData = allExpenses.filter(expense => {
            const expenseDate = new Date(expense.expenseDate);
            return expenseDate >= startDate && expenseDate <= endDate;
        });

        const totalExpenseSum = expenseData.reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
        const netTotal = totalRevenueSum - totalExpenseSum;

        // 1. Create the HTML table structure with styles
        let reportHtml = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="UTF-8">
            <!--[if gte mso 9]>
            <xml>
                <x:ExcelWorkbook>
                    <x:ExcelWorksheets>
                        <x:ExcelWorksheet>
                            <x:Name>Orders</x:Name>
                            <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>
                        </x:ExcelWorksheet>
                    </x:ExcelWorksheets>
                </x:ExcelWorkbook>
            </xml>
            <![endif]-->
            <style>
                table, th, td { border: 1px solid #E2E8F0; border-collapse: collapse; }
                th, td { padding: 8px; text-align: left; font-family: Arial, sans-serif; font-size: 12px; }
                th { background-color: #4A90E2; font-weight: bold; color: #FFFFFF; font-size: 14px; height: 40px; }
                .status-pending { background-color: #F1F5F9; color: #475569; }
                .status-in_progress { background-color: #EFF6FF; color: #2563EB; } 
                .status-ready { background-color: #FFFBEB; color: #D97706; }
                .status-delivered { background-color: #F0FDF4; color: #16A34A; }
                .currency { mso-number-format:"\\₦\\ #\\,\\##0\\.00"; }
                .expense-amount { mso-number-format:"\\₦\\ #\\,\\##0\\.00"; color: #DC2626; }
                .total-row td { font-weight: bold; font-size: 13px; background-color: #F8FAFC; }
                .net-total-row td { font-weight: bold; font-size: 14px; background-color: #E0E7FF; }
                .report-title { font-size: 32px; font-weight: bold; color: #1E40AF; text-align: center; margin-bottom: 4px; }
                .report-subtitle { font-size: 18px; font-weight: bold; color: #374151; text-align: center; margin-bottom: 16px; }
                .section-title { font-size: 22px; font-weight: bold; color: #1E3A8A; margin-top: 30px; margin-bottom: 10px; }
            </style>
        </head>
        <body>
            <div class="report-title">${escapeHtml(appSettings.businessName || 'Laundry Report')}</div>
            <div class="report-subtitle">Financial Report (${startVal} to ${endVal})</div>

            <div class="section-title">Revenue (Orders)</div>
            <table>
                <thead>
                    <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                </thead>
                <tbody>
        `;

        // 2. Populate table rows with data
        revenueData.forEach(order => {
            const itemsString = order.items.map(item =>
                `${item.description} (Qty: ${item.quantity}, Price: ${item.price})`
            ).join('; ');
            const statusMeta = getStatusMeta(order.status);

            reportHtml += `
                <tr>
                    <td>${order.id}</td>
                    <td>${formatDate(order.timestamp)}</td>
                    <td>${escapeHtml(order.customer.name)}</td>
                    <td>${escapeHtml(order.customer.phone)}</td>
                    <td>${escapeHtml(order.customer.address)}</td>
                    <td class="status-${statusMeta.value}">${statusMeta.label}</td>
                    <td class="currency">${order.totalAmount || 0}</td>
                    <td>${escapeHtml(itemsString)}</td>
                </tr>
            `;
        });

        // 3. Add the footer row for the revenue total
        reportHtml += `
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="6" style="text-align: right;">Total:</td>
                        <td class="currency">${totalRevenueSum}</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>`;

        // 4. Add Expense Table if there are expenses
        if (expenseData.length > 0) {
            reportHtml += `
                <div class="section-title">Expenses</div>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            expenseData.forEach(expense => {
                reportHtml += `
                    <tr>
                        <td>${expense.expenseDate}</td>
                        <td>${escapeHtml(expense.description)}</td>
                        <td>${escapeHtml(expense.category)}</td>
                        <td class="expense-amount">${expense.amount}</td>
                    </tr>
                `;
            });
            reportHtml += `
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3" style="text-align: right;">Total Expenses:</td>
                            <td class="expense-amount">${totalExpenseSum}</td>
                        </tr>
                        <tr class="net-total-row">
                            <td colspan="3" style="text-align: right;">Net Total (Revenue - Expenses):</td>
                            <td class="currency">${netTotal}</td>
                        </tr>
                    </tfoot>
                </table>`;
        }
        reportHtml += `</body></html>`;

        const blob = new Blob([reportHtml], { type: 'application/vnd.ms-excel' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `laundry_orders_${new Date().toISOString().split('T')[0]}.xls`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Export started...", "success");
    }
</script>
</body>
</html>
