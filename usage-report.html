<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Usage Report - Laundry Management</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="apple-touch-icon" sizes="180x180" href="../assets/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="../assets/img/favicon/site.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

   <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f7; color: #1d1d1f; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
   </style>
</head>
<body class="antialiased min-h-screen pb-10">

<div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl transform translate-x-full transition-transform duration-300 z-[9999] flex items-center gap-3">
    <i class="fas fa-info-circle"></i>
    <span id="toastMsg">Notification</span>
</div>

<header class="bg-white border-b border-gray-200 sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <img src="./assets/img/blue-logo.png" alt="Logo" class="w-8 h-8">
            <h1 class="font-bold text-xl tracking-tight text-blue-600">Bumba Businesses Ventures - Laundry Dashboard</h1>
        </div>
        <a href="./index.html" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition">
            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-5 border-b border-gray-100">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h3 class="font-semibold text-gray-900 text-lg">Inventory Usage Report</h3>
                    <p class="text-xs text-gray-500 mt-1">A detailed history of all materials used.</p>
                </div>
                <div class="relative w-full sm:w-64">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                    <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Search by item name or notes..." class="w-full pl-8 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-500 transition">
                </div>
            </div>
        </div>

        <div class="overflow-x-auto relative">
            <table class="w-full text-left border-collapse">
                <thead class="sticky top-[64px] bg-gray-50 z-10">
                    <tr class="text-gray-500 text-xs uppercase tracking-wider border-b border-gray-100">
                        <th class="px-6 py-3 font-medium">Date Used</th>
                        <th class="px-6 py-3 font-medium">Item Name</th>
                        <th class="px-6 py-3 font-medium text-center">Quantity Used</th>
                        <th class="px-6 py-3 font-medium">Current Stock</th>
                        <th class="px-6 py-3 font-medium">Notes</th>
                        <th class="px-6 py-3 font-medium text-right">Expenses</th>
                        <th class="px-6 py-3 font-medium text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody" class="text-sm divide-y divide-gray-100">
                    <tr><td colspan="6" class="text-center p-10 text-gray-500">Loading usage history...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="p-4 border-t border-gray-100 flex justify-between items-center" id="paginationControls">
            <span class="text-xs text-gray-500" id="paginationInfo">Showing 0 of 0</span>
            <div class="flex gap-1">
                <button onclick="changePage(-1)" id="prevBtn" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs disabled:opacity-50" disabled>Prev</button>
                <button onclick="changePage(1)" id="nextBtn" class="px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-50 text-xs disabled:opacity-50" disabled>Next</button>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 flex justify-end items-center">
            <span class="text-sm font-semibold text-gray-700 mr-2">Total Inventory Usage Expenses:</span>
            <span class="text-sm font-bold text-red-600" id="reportTotalInventoryUsageExpenses">₦0.00</span>
        </div>
    </div>
</main>

<script>
    /*******************************
     * 1. FIREBASE SETUP
     *******************************/
    const firebaseConfig = {
        apiKey: "AIzaSyCGBqbJk546uJChQUrIUUIaXt20FOpnyr8",
        authDomain: "laundry-management-b5198.firebaseapp.com",
        projectId: "laundry-management-b5198",
        appId: "1:253804986338:web:464940df509269255803bb",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /*******************************
     * 2. STATE MANAGEMENT
     *******************************/
    let allUsageLogs = [];
    let filteredLogs = [];
    let currentPage = 1;
    const rowsPerPage = 15;

    /*******************************
     * 3. INITIALIZATION & DATA FETCHING
     *******************************/
    async function init() {
        try {
            await firebase.auth().signInAnonymously();
            setupUsageListener();
        } catch (error) {
            console.error("Auth failed:", error);
            showToast("Could not connect to the database.", "error");
        }
    }

    function getInventoryUsageCollectionRef() {
        return db.collection("artifacts").doc(firebaseConfig.appId).collection("public").doc("data").collection("inventory_usage");
    }

    function setupUsageListener() {
        const collectionRef = getInventoryUsageCollectionRef();
        console.log("Firestore collection path being queried:", collectionRef.path);
        collectionRef.orderBy("usedAt", "desc").onSnapshot(snapshot => {
            allUsageLogs = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    usedAt: data.usedAt instanceof firebase.firestore.Timestamp ? data.usedAt.toDate() : new Date(),
                    unit: data.unit || '' // Add unit to the log object
                };
            });
            console.log(`Fetched ${allUsageLogs.length} usage logs.`);
            if (allUsageLogs.length === 0) {
                console.warn("No usage logs found in the specified Firestore collection.");
                showToast("No usage records found. Please add some inventory usage data.", "info");
            } else {
                showToast("Usage history loaded.", "success");
            }
            handleSearch(); // Initial render
        }, error => {
            console.error("Error fetching usage history from Firestore:", error);
            showToast("Failed to load usage history. Check console for details.", "error");
            document.querySelector("#reportTableBody tr td").textContent = "Error loading data.";
        });
    }

    /*******************************
     * 4. RENDERING & UI LOGIC
     *******************************/
    function handleSearch() {
        const query = document.getElementById('searchInput').value.toLowerCase().trim();
        console.log("Search query:", query === "" ? "[empty]" : query);
        if (!query) {
            filteredLogs = [...allUsageLogs];
        } else {
            filteredLogs = allUsageLogs.filter(log => {
                const name = log.itemName?.toLowerCase() || '';
                const notes = log.notes?.toLowerCase() || '';
                return name.includes(query) || notes.includes(query);
            });
        }
        console.log(`handleSearch: allUsageLogs count = ${allUsageLogs.length}, filteredLogs count = ${filteredLogs.length}`);
        currentPage = 1;
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('reportTableBody');
        tbody.innerHTML = '';

        let grandTotalExpenses = 0;

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filteredLogs.slice(start, end);
        console.log(`renderTable: currentPage = ${currentPage}, rowsPerPage = ${rowsPerPage}, filteredLogs count = ${filteredLogs.length}, pageData count = ${pageData.length}`);

        if (pageData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No usage records found for this search.</td></tr>`;
            updatePagination(0);
            document.getElementById('reportTotalInventoryUsageExpenses').textContent = formatCurrency(0, false);
            return;
        }

        pageData.forEach(log => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 transition';
            const expenseAmount = log.expenseAmount || 0;
            grandTotalExpenses += expenseAmount;

            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-gray-600">${formatDateTime(log.usedAt)}</td>
                <td class="px-6 py-4 font-medium text-gray-800">${escapeHtml(log.itemName)}</td>
                <td class="px-6 py-4 font-semibold text-orange-600 text-center">${log.quantityUsed}</td>
                <td class="px-6 py-4 text-gray-500">${escapeHtml(log.unit)}</td>
                <td class="px-6 py-4 text-gray-500 text-xs">${escapeHtml(log.notes) || 'N/A'}</td>
                <td class="px-6 py-4 font-semibold text-red-600 text-right">${formatCurrency(expenseAmount, false)}</td>
                <td class="px-6 py-4 text-right">
                    <button onclick='deleteLog("${log.id}")' class="p-2 text-sm text-red-500 hover:bg-red-50 rounded transition" title="Delete Log Entry"><i class="fas fa-trash-alt"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        updatePagination(filteredLogs.length);
        document.getElementById('reportTotalInventoryUsageExpenses').textContent = formatCurrency(grandTotalExpenses, false);
    }

    function updatePagination(totalRows) {
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        document.getElementById('paginationInfo').textContent = `Showing ${totalRows > 0 ? start + 1 : 0} to ${Math.min(end, totalRows)} of ${totalRows}`;
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    function changePage(delta) {
        const totalPages = Math.ceil(filteredLogs.length / rowsPerPage);
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderTable();
        }
    }

    async function deleteLog(logId) {
        if (!confirm("Are you sure you want to delete this usage log? This action cannot be undone.")) {
            return;
        }
        try {
            await getInventoryUsageCollectionRef().doc(logId).delete();
            showToast("Log entry deleted.", "success");
            // The listener will automatically refresh the table.
        } catch (error) {
            console.error("Error deleting log entry:", error);
            showToast("Failed to delete log entry.", "error");
        }
    }

    /*******************************
     * 5. UTILS
     *******************************/
     function formatCurrency(amount, includeSymbol = true) {
        // Assuming Nigerian Naira (₦) based on the HTML template (₦0.00)
        // and formatting to 2 decimal places.
        const formattedAmount = new Intl.NumberFormat('en-NG', {
            style: 'currency',
            currency: 'NGN',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        }).format(amount);

        if (!includeSymbol) {
            // Remove the currency symbol if not requested
            return formattedAmount.replace('₦', '').trim();
        }
        return formattedAmount;
    }
    function formatDateTime(date) {
        if (!(date instanceof Date)) return 'Invalid Date';
        return date.toLocaleString('en-US', {
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit', hour12: true
        });
    }

    function escapeHtml(text) {
        if (text === null || typeof text === 'undefined') return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    function showToast(msg, type) {
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMsg');
        toastMsg.textContent = msg;
        toast.className = `fixed top-5 right-5 px-6 py-3 rounded-lg shadow-xl transform transition-transform duration-300 z-[9999] flex items-center gap-3 text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
        toast.classList.remove('translate-x-full');
        setTimeout(() => {
            toast.classList.add('translate-x-full');
        }, 3000);
    }

    // Initialize the page
    init();
</script>

</body>
</html>